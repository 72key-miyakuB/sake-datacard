<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSC Admin | Reviews Moderation</title>
  <style>
    :root{
      --bg:#0b0d12; --text:rgba(255,255,255,.92); --muted:rgba(255,255,255,.68);
      --line:rgba(255,255,255,.12); --r:16px; --shadow:0 14px 40px rgba(0,0,0,.45);
      --accent:#d7b56d;
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--font);line-height:1.45}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .card{border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04)); overflow:hidden}
    .hd{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;gap:10px;align-items:center}
    .title{font-weight:900}
    .muted{color:var(--muted)}
    input,button{border-radius:12px;border:1px solid var(--line);background:rgba(0,0,0,.25);color:var(--text);padding:10px}
    button{cursor:pointer;border-color:rgba(215,181,109,.35);background:rgba(215,181,109,.18);font-weight:800}
    button.secondary{border-color:var(--line);background:rgba(255,255,255,.05);font-weight:650}
    .body{padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .pill{border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.03);font-size:12px;color:var(--muted)}
    .table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    .table th,.table td{border-top:1px solid var(--line);padding:10px 8px;vertical-align:top}
    .table th{color:var(--muted);text-align:left;width:160px}
    .danger{background:rgba(255,122,122,.12);border-color:rgba(255,122,122,.35)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd">
        <div>
          <div class="title">TSC Admin / レビュー管理</div>
          <div class="muted" style="font-size:12px;">削除は管理者のみ。荒らし対応用。</div>
        </div>
        <div class="pill" id="status">Loading…</div>
      </div>

      <div class="body">
        <div class="card" style="margin-bottom:12px;">
          <div class="hd">
            <div class="title">Login</div>
            <div class="pill" id="uidPill">uid: —</div>
          </div>
          <div class="body">
            <div class="row">
              <input id="email" placeholder="admin email" style="flex:1;min-width:220px" />
              <input id="pass" placeholder="password" type="password" style="flex:1;min-width:220px" />
              <button id="loginBtn">Sign in</button>
              <button id="logoutBtn" class="secondary">Sign out</button>
            </div>
            <div class="muted" style="font-size:12px;margin-top:8px;">
              ※ UIDホワイトリスト方式の場合、このUIDを Firestore Rules に登録してください。
            </div>
          </div>
        </div>

        <div class="row">
          <input id="filterSakeId" placeholder="filter by sakeId (optional)" style="flex:1;min-width:220px" />
          <button id="reloadBtn" class="secondary">Reload</button>
        </div>

        <table class="table" aria-label="reviews table">
          <thead>
            <tr>
              <th>when</th>
              <th>sakeId</th>
              <th>name</th>
              <th>rating</th>
              <th>msg</th>
              <th>docId</th>
              <th>action</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>

        <div class="muted" style="font-size:12px;margin-top:10px;">
          ※ docId は「sakeId_uid」。同じ人は同じ銘柄に1回まで。
        </div>
      </div>
    </div>
  </div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD1sbz6sLUMf6tabsjwvteEOoQB6vFlcZU",
      authDomain: "the-sake-council-reviews.firebaseapp.com",
      projectId: "the-sake-council-reviews",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const statusEl = document.getElementById("status");
    const uidPill = document.getElementById("uidPill");
    const tbody = document.getElementById("tbody");

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;")
        .replaceAll(">","&gt;").replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    auth.onAuthStateChanged(u=>{
      uidPill.textContent = `uid: ${u ? String(u.uid) : "—"}`;
      statusEl.textContent = u ? "Signed in ✅" : "Signed out";
    });

    document.getElementById("loginBtn").onclick = async ()=>{
      try{
        const email = document.getElementById("email").value.trim();
        const pass = document.getElementById("pass").value;
        await auth.signInWithEmailAndPassword(email, pass);
        statusEl.textContent = "Signed in ✅";
      }catch(e){
        console.error(e);
        statusEl.textContent = `Login failed: ${e.message || e}`;
      }
    };

    document.getElementById("logoutBtn").onclick = async ()=>{
      await auth.signOut();
      statusEl.textContent = "Signed out";
      tbody.innerHTML = "";
    };

    async function loadReviews(){
      const u = auth.currentUser;
      if (!u){
        statusEl.textContent = "Please sign in first.";
        return;
      }

      const filterSakeId = document.getElementById("filterSakeId").value.trim();
      tbody.innerHTML = "";
      statusEl.textContent = "Loading…";

      try{
        let q = db.collection("reviews").orderBy("ts", "desc").limit(200);
        if (filterSakeId) q = db.collection("reviews").where("sakeId", "==", filterSakeId).orderBy("ts", "desc").limit(200);

        const snap = await q.get();
        if (snap.empty){
          tbody.innerHTML = `<tr><td class="muted" colspan="7">No reviews.</td></tr>`;
          statusEl.textContent = "Loaded ✅ (0)";
          return;
        }

        const rows = [];
        snap.forEach(doc=>{
          const r = doc.data() || {};
          const d = r.ts?.toDate?.() ? r.ts.toDate() : null;
          const when = d ? d.toLocaleString() : "—";
          rows.push(`
            <tr>
              <td class="muted">${esc(when)}</td>
              <td>${esc(r.sakeId || "")}</td>
              <td>${esc(r.name || "")}</td>
              <td>${esc(r.rating || "")}</td>
              <td>${esc(r.msg || "")}</td>
              <td class="muted">${esc(doc.id)}</td>
              <td>
                <button class="danger" data-del="${esc(doc.id)}">Delete</button>
              </td>
            </tr>
          `);
        });

        tbody.innerHTML = rows.join("");
        statusEl.textContent = `Loaded ✅ (${snap.size})`;

        // bind delete buttons
        Array.from(document.querySelectorAll("button[data-del]")).forEach(btn=>{
          btn.onclick = async ()=>{
            const id = btn.getAttribute("data-del");
            if (!id) return;
            if (!confirm(`Delete this review?\n${id}`)) return;
            try{
              await db.collection("reviews").doc(id).delete();
              statusEl.textContent = "Deleted ✅";
              await loadReviews();
            }catch(e){
              console.error(e);
              statusEl.textContent = `Delete failed: ${e.message || e}`;
            }
          };
        });

      }catch(e){
        console.error(e);
        statusEl.textContent = `Load failed: ${e.message || e}`;
      }
    }

    document.getElementById("reloadBtn").onclick = loadReviews;
    statusEl.textContent = "Ready";
  </script>
</body>
</html>
