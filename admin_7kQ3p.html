<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TSC Admin | Review Moderation</title>
  <meta name="robots" content="noindex,nofollow" />
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d7b56d;
      --danger:#ff7a7a;
      --ok:#7ee3a6;
      --r:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Arial;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(215,181,109,.10), transparent 60%),
                  radial-gradient(1000px 600px at 90% 15%, rgba(126,227,166,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.45;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px; }
    header{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin: 10px 0 14px; }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .name{ font-weight: 820; letter-spacing:.2px; }
    .brand .sub{ color:var(--muted); font-size: 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--line);
      border-radius: 999px; background: rgba(255,255,255,.03);
      font-size: 12px; color: var(--muted);
      white-space:nowrap;
    }
    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      margin-bottom: 14px;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .title .jp{ font-size: 16px; font-weight: 820; }
    .title .en{ font-size: 12px; color: var(--muted); }
    .body{ padding: 14px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 8px; }

    input{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      outline:none;
    }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }

    button{
      appearance:none; border:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(215,181,109,.18);
      border: 1px solid rgba(215,181,109,.35);
      color: var(--text);
      font-weight: 760;
      cursor:pointer;
    }
    button.secondary{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
    }
    button.danger{
      background: rgba(255,122,122,.12);
      border: 1px solid rgba(255,122,122,.35);
      color: var(--text);
      font-weight: 760;
    }

    .list{ display:flex; flex-direction:column; gap:10px; margin-top: 10px; }
    .item{
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .item .top{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
      margin-bottom: 6px;
    }
    .item .msg{ font-size: 13px; white-space:pre-wrap; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 11px; color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 8px;
      width: fit-content;
      background: rgba(0,0,0,.12);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }
    .ok{ color: var(--ok); }
    .dangerText{ color: var(--danger); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">The Sake Council Tokyo</div>
        <div class="sub">Admin / Review Moderation</div>
      </div>
      <div class="pill" id="status">Loading…</div>
    </header>

    <!-- Login -->
    <section class="card" id="loginCard" style="display:none;">
      <div class="hd">
        <div class="title">
          <div class="jp">管理者ログイン</div>
          <div class="en">Email & Password</div>
        </div>
        <div class="badge">Firebase Auth</div>
      </div>
      <div class="body">
        <div class="grid">
          <div>
            <div class="badge">Email</div>
            <input id="email" placeholder="admin@example.com" autocomplete="username" />
          </div>
          <div>
            <div class="badge">Password</div>
            <input id="password" type="password" placeholder="••••••••" autocomplete="current-password" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <button id="loginBtn" type="button">Login</button>
        </div>

        <div class="hint">
          ※ admin は GitHub に置いてOKですが、<span class="dangerText">ファイル名を推測不能に</span>して下さい（例: admin_7kQ3p.html）。
        </div>
      </div>
    </section>

    <!-- Admin console -->
    <section class="card" id="adminCard" style="display:none;">
      <div class="hd">
        <div class="title">
          <div class="jp">レビュー管理</div>
          <div class="en">Search / Delete</div>
        </div>
        <div class="row">
          <span class="badge" id="meBadge">me: —</span>
          <button class="secondary" id="logoutBtn" type="button">Logout</button>
        </div>
      </div>

      <div class="body">
        <div class="grid">
          <div>
            <div class="badge">Filter: sakeId</div>
            <input id="filterSakeId" placeholder="e.g. taison_kourin" />
            <div class="hint">空なら「最新レビュー（全銘柄）」を表示。</div>
          </div>
          <div>
            <div class="badge">Quick Actions</div>
            <div class="row">
              <button id="reloadBtn" type="button">Reload</button>
              <button class="secondary" id="openBottleBtn" type="button">Open bottle page</button>
            </div>
            <div class="hint">Open は同じサイトの <span class="mono">index.html?id=xxx</span> を開きます。</div>
          </div>
        </div>

        <div class="row" style="justify-content:space-between; margin-top:12px;">
          <div class="badge" id="countBadge">—</div>
          <div class="badge">Delete is admin-only</div>
        </div>

        <div class="list" id="reviewList"></div>

        <div class="hint">
          ・通常画面側は「同一ユーザー×同一銘柄＝1回だけ」にできるので、荒らしの連投を抑えられます。<br/>
          ・この画面は店側だけが削除可能（Firestore Rulesで制御）です。
        </div>
      </div>
    </section>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // =========================
    // Firebase設定（index.html と同じ）
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyD1sbz6sLUMf6tabsjwvteEOoQB6vFlcZU",
      authDomain: "the-sake-council-reviews.firebaseapp.com",
      projectId: "the-sake-council-reviews",
    };

    const REVIEWS_COLLECTION = "reviews";
    const REVIEW_LIMIT = 120;

    const statusEl = document.getElementById("status");
    const loginCard = document.getElementById("loginCard");
    const adminCard = document.getElementById("adminCard");

    let db = null;
    let auth = null;

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function stars(n){
      const k = Math.max(1, Math.min(5, Number(n)||0));
      return "★★★★★".slice(0,k) + "☆☆☆☆☆".slice(0,5-k);
    }
    function setStatus(msg){ statusEl.textContent = msg; }

    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    }catch(e){
      console.error(e);
      setStatus("Firebase init error");
    }

    function showLogin(){
      loginCard.style.display = "";
      adminCard.style.display = "none";
    }
    function showAdmin(){
      loginCard.style.display = "none";
      adminCard.style.display = "";
    }

    async function doLogin(){
      const email = (document.getElementById("email").value || "").trim();
      const password = (document.getElementById("password").value || "").trim();
      if(!email || !password){
        setStatus("Enter email & password");
        return;
      }
      try{
        await auth.signInWithEmailAndPassword(email, password);
        setStatus("Logged in ✅");
      }catch(e){
        console.error(e);
        setStatus(`Login failed: ${e?.message || e}`);
      }
    }

    async function doLogout(){
      try{
        await auth.signOut();
        setStatus("Logged out");
      }catch(e){
        console.error(e);
        setStatus("Logout failed");
      }
    }

    function reviewDocToUi(doc){
      const r = doc.data() || {};
      const d = r.ts?.toDate?.() ?? new Date();
      return {
        id: doc.id,
        sakeId: r.sakeId || "",
        name: r.name || "Guest",
        rating: Math.max(1, Math.min(5, Number(r.rating)||5)),
        msg: r.msg || "",
        uid: r.uid || "",
        dateText: d.toLocaleString()
      };
    }

    function renderList(items){
      const list = document.getElementById("reviewList");
      list.innerHTML = "";

      const countBadge = document.getElementById("countBadge");
      countBadge.textContent = `${items.length} reviews`;

      if(!items.length){
        list.innerHTML = `<div class="hint">No reviews.</div>`;
        return;
      }

      items.forEach(r=>{
        const el = document.createElement("div");
        el.className = "item";
        el.innerHTML = `
          <div class="top">
            <span>
              <span class="badge">sakeId: <span class="mono">${escapeHtml(r.sakeId)}</span></span>
              <span class="badge">${escapeHtml(r.name)} · ${escapeHtml(stars(r.rating))}</span>
            </span>
            <span>
              <span class="badge">${escapeHtml(r.dateText)}</span>
              <span class="badge">uid: <span class="mono">${escapeHtml(String(r.uid).slice(0,10))}</span></span>
            </span>
          </div>
          <div class="msg">${escapeHtml(r.msg)}</div>
          <div class="row" style="margin-top:10px; justify-content:space-between;">
            <span class="badge">doc: <span class="mono">${escapeHtml(r.id)}</span></span>
            <div class="row">
              <button class="secondary" type="button" data-open="${escapeHtml(r.sakeId)}">Open</button>
              <button class="danger" type="button" data-del="${escapeHtml(r.id)}">Delete</button>
            </div>
          </div>
        `;
        list.appendChild(el);
      });

      // bind buttons
      list.querySelectorAll("button[data-open]").forEach(btn=>{
        btn.onclick = () => {
          const sakeId = btn.getAttribute("data-open");
          if(!sakeId) return;
          const url = `./index.html?id=${encodeURIComponent(sakeId)}`;
          window.open(url, "_blank");
        };
      });
      list.querySelectorAll("button[data-del]").forEach(btn=>{
        btn.onclick = async () => {
          const id = btn.getAttribute("data-del");
          if(!id) return;
          // confirm
          const ok = confirm(`Delete review doc?\n${id}`);
          if(!ok) return;
          try{
            await db.collection(REVIEWS_COLLECTION).doc(id).delete();
            setStatus("Deleted ✅");
            await loadAndRender();
          }catch(e){
            console.error(e);
            setStatus(`Delete failed: ${e?.message || e}`);
          }
        };
      });
    }

    async function loadAndRender(){
      if(!db){ setStatus("Firestore not ready"); return; }
      const user = auth.currentUser;
      if(!user){
        setStatus("Not logged in");
        return;
      }

      const filter = (document.getElementById("filterSakeId").value || "").trim();

      try{
        let q = db.collection(REVIEWS_COLLECTION);
        if(filter){
          q = q.where("sakeId", "==", filter).orderBy("ts", "desc").limit(REVIEW_LIMIT);
        }else{
          q = q.orderBy("ts", "desc").limit(REVIEW_LIMIT);
        }
        const snap = await q.get();
        const items = [];
        snap.forEach(d => items.push(reviewDocToUi(d)));
        renderList(items);
        setStatus(filter ? `Loaded ✅ (sakeId=${filter})` : "Loaded ✅ (latest)");
      }catch(e){
        console.error(e);
        // where + orderBy のインデックス不足が出ることがあるのでメッセージをわかりやすく
        const msg = e?.message || String(e);
        if(msg.includes("index")){
          setStatus("Index required: Firestore console の案内リンクから index を作成してください");
        }else{
          setStatus(`Load failed: ${msg}`);
        }
      }
    }

    // UI bind
    document.getElementById("loginBtn").onclick = doLogin;
    document.getElementById("logoutBtn").onclick = doLogout;
    document.getElementById("reloadBtn").onclick = loadAndRender;
    document.getElementById("openBottleBtn").onclick = () => {
      const filter = (document.getElementById("filterSakeId").value || "").trim();
      if(!filter){ alert("sakeId を入れてください"); return; }
      window.open(`./index.html?id=${encodeURIComponent(filter)}`, "_blank");
    };

    // auth state
    if(auth){
      auth.onAuthStateChanged(async (u)=>{
        if(!u){
          showLogin();
          setStatus("Please login");
          return;
        }
        // 匿名ログインで admin が開かれたら弾く（運用上の事故防止）
        if(u.isAnonymous){
          await auth.signOut();
          showLogin();
          setStatus("Anonymous is not allowed for admin");
          return;
        }
        document.getElementById("meBadge").textContent = `me: ${String(u.email || u.uid).slice(0,40)}`;
        showAdmin();
        await loadAndRender();
      });
    }else{
      showLogin();
      setStatus("Auth not ready");
    }
  </script>
</body>
</html>
