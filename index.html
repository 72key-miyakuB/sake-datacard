<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Sake Council Tokyo | Sake Sheet</title>
  <meta name="description" content="Sake bottle info (JP/EN) with quick visuals + shared reviews." />
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d7b56d;
      --ok:#7ee3a6;
      --warn:#ffcf6b;
      --danger:#ff7a7a;
      --r:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(215,181,109,.10), transparent 60%),
                  radial-gradient(1000px 600px at 90% 15%, rgba(126,227,166,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.45;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px; }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin: 10px 0 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .name{ font-weight: 750; letter-spacing:.2px; }
    .brand .sub{ color:var(--muted); font-size: 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--line);
      border-radius: 999px; background: rgba(255,255,255,.03);
      font-size: 12px; color: var(--muted);
      white-space:nowrap;
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    @media (max-width: 860px){ .grid{ grid-template-columns: 1fr; } }
    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .title .jp{ font-size: 18px; font-weight: 800; }
    .title .en{ font-size: 12px; color: var(--muted); }
    .tags{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
    .tag{
      font-size: 11px;
      padding: 6px 8px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      color: var(--muted);
    }
    .body{ padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      flex:1; min-width: 170px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .kpi .k{ font-size: 11px; color: var(--muted); display:flex; justify-content:space-between; gap:10px; }
    .kpi .v{ font-size: 14px; font-weight: 750; margin-top: 4px; }
    .mini{ font-size: 11px; color: var(--muted); margin-top: 2px; }
    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .table th,.table td{
      border-top: 1px solid var(--line);
      padding: 10px 8px;
      vertical-align: top;
    }
    .table th{ text-align:left; color: var(--muted); width: 34%; font-weight: 650; }
    .muted{ color: var(--muted); }
    .viz{ display:grid; grid-template-columns: 1fr; gap: 10px; }
    .bar{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .bar .label{ width: 84px; font-size: 12px; color: var(--muted); }
    .track{
      flex:1; height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(215,181,109,.95), rgba(126,227,166,.85));
    }
    .bar .val{ width: 28px; text-align:right; font-size: 12px; color: var(--muted); }
    .chart{
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .chart .caption{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-bottom: 8px;
    }
    .svgwrap{ width:100%; display:flex; justify-content:center; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button, .btn{
      appearance:none; border:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(215,181,109,.18);
      border: 1px solid rgba(215,181,109,.35);
      color: var(--text);
      font-weight: 700;
      cursor:pointer;
    }
    button.secondary, .btn.secondary{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
    }
    .btn{ display:inline-flex; align-items:center; gap:8px; }
    .hint{ font-size: 11px; color: var(--muted); margin-top: 8px; }
    .reviews{
      display:flex; flex-direction:column; gap:10px;
      margin-top: 12px;
    }
    .review{
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .review .top{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
      margin-bottom: 6px;
    }
    .review .msg{ font-size: 13px; }
    .form{
      margin-top: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
    }
    .formgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .formgrid{ grid-template-columns: 1fr; } }
    input, textarea, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }
    .footnote{
      padding: 14px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
      background: rgba(255,255,255,.02);
    }
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 700px){ .list{ grid-template-columns: 1fr; } }
    .item{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .item .n{ font-weight: 800; }
    .item .s{ color: var(--muted); font-size: 12px; }
    .item .go{ margin-top:auto; }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 11px; color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 8px;
      width: fit-content;
      background: rgba(0,0,0,.12);
    }
    .warnbox{
      border: 1px solid rgba(255,207,107,.45);
      background: rgba(255,207,107,.08);
      color: rgba(255,255,255,.85);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 12px;
      margin-top: 10px;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">The Sake Council Tokyo</div>
        <div class="sub">Sake Bottle Info / éŠ˜æŸ„æƒ…å ±ï¼ˆQRï¼‰</div>
      </div>
      <div class="pill" id="status">Loadingâ€¦</div>
    </header>

    <main class="grid">
      <!-- Left: Sake Sheet -->
      <section class="card" id="sheetCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp" id="name_jp">â€”</div>
            <div class="en" id="name_en">â€”</div>
          </div>
          <div class="tags" id="tags"></div>
        </div>

        <div class="body">
          <div class="row">
            <div class="kpi">
              <div class="k"><span>è”µ / Brewery</span><span class="muted">JP/EN</span></div>
              <div class="v" id="brewery">â€”</div>
              <div class="mini" id="region">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¿ã‚¤ãƒ— / Type</span><span class="muted">Style</span></div>
              <div class="v" id="style">â€”</div>
              <div class="mini" id="rice">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¹ãƒšãƒƒã‚¯ / Spec</span><span class="muted">ABVãƒ»SMV</span></div>
              <div class="v" id="spec">â€”</div>
              <div class="mini" id="polish">â€”</div>
            </div>
          </div>

          <table class="table" aria-label="Sake quick table">
            <tr><th>é¦™ã‚Š / Aroma</th><td id="aroma">â€”</td></tr>
            <tr><th>å‘³ã‚ã„ / Palate</th><td id="palate">â€”</td></tr>
            <tr><th>ç›¸æ€§ / Pairing</th><td id="pairing">â€”</td></tr>
            <tr><th>æ¸©åº¦ / Temp</th><td id="temp">â€”</td></tr>
            <tr><th>ã‚°ãƒ©ã‚¹ / Glass</th><td id="glass">â€”</td></tr>
            <tr><th>ã²ã¨è¨€ / One-liner</th><td id="copy">â€”</td></tr>
          </table>

          <div class="actions">
            <a class="btn secondary" id="copyLinkBtn" href="#">ğŸ”— Link / ãƒªãƒ³ã‚¯</a>
            <button class="secondary" id="copyQrTextBtn" type="button">ğŸ“ QRç”¨URLã‚³ãƒ”ãƒ¼</button>
          </div>

          <div class="hint">
            â€» QRã¯ <span class="muted">index.html?id=éŠ˜æŸ„ID</span> ã‚’æƒ³å®šï¼ˆCSVã®idåˆ—ï¼‰ã€‚
          </div>
        </div>

        <div class="footnote">
          <span>âœ… Reviews are shared across devices (Firestore).</span>
          <span class="muted">æŠ•ç¨¿ã¯å…¨ç«¯æœ«ã«åæ˜ </span>
        </div>
      </section>

      <!-- Right: Visuals + Reviews -->
      <aside class="card" id="sideCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp">ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« / Visual</div>
            <div class="en">Quick taste map + shared reviews</div>
          </div>
          <div class="tags">
            <span class="tag" id="idTag">id: â€”</span>
          </div>
        </div>

        <div class="body">
          <div class="viz">
            <!-- Bars -->
            <div class="bar">
              <div class="label">ç”˜è¾› / Sweet-Dry</div>
              <div class="track"><div class="fill" id="bar_sweet"></div></div>
              <div class="val" id="val_sweet">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é¦™ã‚Š / Aroma</div>
              <div class="track"><div class="fill" id="bar_aroma"></div></div>
              <div class="val" id="val_aroma">â€”</div>
            </div>
            <div class="bar">
              <div class="label">ã‚³ã‚¯ / Body</div>
              <div class="track"><div class="fill" id="bar_body"></div></div>
              <div class="val" id="val_body">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é…¸ / Acidity</div>
              <div class="track"><div class="fill" id="bar_acid"></div></div>
              <div class="val" id="val_acid">â€”</div>
            </div>

            <!-- Mini chart -->
            <div class="chart">
              <div class="caption">
                <span>å‘³ã‚ã„ãƒãƒƒãƒ— / Taste Map</span>
                <span class="muted">0â€“5</span>
              </div>
              <div class="svgwrap" id="tasteSvgWrap"></div>
              <div class="hint muted">â€»æ•°å€¤ã¯CSVã® (sweet, aroma_intensity, body, acidity) ã‚’ä½¿ç”¨ã€‚</div>
            </div>

            <!-- Reviews -->
            <div>
              <div class="row" style="justify-content:space-between; align-items:center;">
                <div class="badge">ğŸ—’ Reviews / ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="badge" id="ratingBadge">â€”</div>
              </div>

              <div class="reviews" id="reviews"></div>

              <div class="form" aria-label="Review form">
                <div class="formgrid">
                  <div>
                    <div class="muted" style="font-size:12px; margin:0 0 6px;">Name / ãŠåå‰</div>
                    <input id="rv_name" placeholder="e.g. Alex / ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹" maxlength="30" />
                  </div>
                  <div>
                    <div class="muted" style="font-size:12px; margin:0 0 6px;">Rating / è©•ä¾¡</div>
                    <select id="rv_rating">
                      <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                      <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                      <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                      <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                      <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                    </select>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <div class="muted" style="font-size:12px; margin:0 0 6px;">Comment / ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                  <textarea id="rv_msg" placeholder="Short impressions / ã²ã¨ã“ã¨æ„Ÿæƒ³ï¼ˆçŸ­ã‚æ¨å¥¨ï¼‰" maxlength="240"></textarea>
                </div>
                <div class="actions" style="margin-top:10px;">
                  <button id="submitReviewBtn" type="button">âœï¸ Post / æŠ•ç¨¿</button>
                  <button class="secondary" id="exportReviewsBtn" type="button">â¬‡ï¸ Export JSON</button>
                </div>
                <div class="hint">
                  â€» å…¨å“¡å…±æœ‰ï¼ˆFirestoreï¼‰ã€‚ä¸é©åˆ‡æŠ•ç¨¿å¯¾ç­–ã¯ã€Œãƒ«ãƒ¼ãƒ«/èªè¨¼ã€ã§å¼·åŒ–ã§ãã¾ã™ã€‚
                </div>
                <div class="warnbox">
                  Tip: Firestoreã®ç„¡æ–™æ ã§ã‚‚å¤šãã®åº—èˆ—é‹ç”¨ã¯ååˆ†ã§ã™ã€‚<br/>
                  æœ¬æ ¼é‹ç”¨ã¯ã€Œæ–‡å­—æ•°åˆ¶é™/NGãƒ¯ãƒ¼ãƒ‰ã€ã€Œç®¡ç†è€…ã ã‘å‰Šé™¤ã€ã€ŒåŒ¿åIDä»˜ä¸ã€ãªã©ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
                </div>
              </div>
            </div>

          </div>
        </div>
      </aside>

      <!-- List view (when no id param) -->
      <section class="card" id="listCard" style="display:none; grid-column: 1 / -1;">
        <div class="hd">
          <div class="title">
            <div class="jp">éŠ˜æŸ„ä¸€è¦§ / Sake List</div>
            <div class="en">Tap a bottle to open its QR page.</div>
          </div>
          <div class="tags">
            <span class="tag" id="countTag">â€”</span>
          </div>
        </div>
        <div class="body">
          <div class="list" id="list"></div>
          <div class="hint">QRã¯ <span class="muted">index.html?id=éŠ˜æŸ„ID</span> ã‚’ç”Ÿæˆã—ã¦è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚</div>
        </div>
      </section>
    </main>
  </div>

  <!-- âœ… Firebase (Firestore) SDK - compatç‰ˆï¼ˆå˜ä¸€HTMLã§ç°¡å˜é‹ç”¨ï¼‰ -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>
    /**
     * âœ… ä½¿ã„æ–¹
     * - åŒéšå±¤ã« sake.csv ã‚’ç½®ã
     * - QR: index.html?id=éŠ˜æŸ„ID
     *
     * âœ… Firebaseè¨­å®š
     * - ä¸‹ã® firebaseConfig ã‚’ Firebase Console ã®å€¤ã«å·®ã—æ›¿ãˆã‚‹
     * - Firestoreã®ãƒ«ãƒ¼ãƒ«ã¯ä¸‹ã®ã€Œãƒ«ãƒ¼ãƒ«ä¾‹ã€ã‚’å‚ç…§
     */

    // =========================
    // 1) Firebaseè¨­å®šï¼ˆè¦å·®ã—æ›¿ãˆï¼‰
    // =========================
    const firebaseConfig = {
        apiKey: "AIzaSyD1sbz6sLUMf6tabsjwvteEOoQB6vFlcZU",
        authDomain: "the-sake-council-reviews.firebaseapp.com",
        projectId: "the-sake-council-reviews",
      // storageBucket / messagingSenderId / appId ã¯ä¸è¦ãªã‚‰çœç•¥ã—ã¦OK
    };

    // =========================
    // 2) App settings
    // =========================
    const CSV_PATH = "./sake.csv";
    const REVIEWS_COLLECTION = "reviews";   // Firestore collection name
    const REVIEW_LIMIT = 60;                // è¡¨ç¤ºã™ã‚‹æœ€å¤§ä»¶æ•°
    const statusEl = document.getElementById("status");

    // Query param
    const qs = new URLSearchParams(location.search);
    const targetId = qs.get("id"); // per-bottle view
    let currentSakeId = null;

    // Firebase init
    let db = null;
    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
    }catch(e){
      console.error(e);
    }

    // ---------- Helpers ----------
    function clamp01(n){ return Math.max(0, Math.min(1, n)); }
    function toNum(v, fallback=0){
      const n = Number(String(v).replace(/[^\d.-]/g,""));
      return Number.isFinite(n) ? n : fallback;
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function stars(n){
      const k = Math.max(1, Math.min(5, Number(n)||0));
      return "â˜…â˜…â˜…â˜…â˜…".slice(0,k) + "â˜†â˜†â˜†â˜†â˜†".slice(0,5-k);
    }

    // ---------- CSV parsing ----------
    function parseCSV(text){
      // Simple CSV parser supporting quotes
      const rows = [];
      let cur = "", inQ = false;
      const out = [];
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' && inQ && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQ = !inQ; continue; }
        if (!inQ && ch === ","){ out.push(cur); cur=""; continue; }
        if (!inQ && ch === "\n"){ out.push(cur); rows.push(out.slice()); out.length=0; cur=""; continue; }
        if (ch === "\r") continue;
        cur += ch;
      }
      out.push(cur);
      if (out.some(v => v.length>0)) rows.push(out.slice());

      const header = rows.shift().map(h => h.trim());
      return rows
        .filter(r => r.some(v => (v ?? "").trim() !== ""))
        .map(r => {
          const obj = {};
          header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
    }

    // ---------- visuals ----------
    function setBar(elId, value0to5){
      const v = Math.max(0, Math.min(5, toNum(value0to5, 0)));
      const pct = (v/5)*100;
      const el = document.getElementById(elId);
      el.style.width = pct + "%";
      return v;
    }

    function tasteSvg({sweet, aroma, body, acid}){
      // Simple diamond chart (4 axes) in SVG
      // top: aroma, right: sweet, bottom: body, left: acid
      const W=220, H=160, cx=W/2, cy=H/2;
      const max=5;
      const r=58;

      const a = clamp01(aroma/max)*r;
      const s = clamp01(sweet/max)*r;
      const b = clamp01(body/max)*r;
      const ac = clamp01(acid/max)*r;

      const pTop    = [cx, cy - a];
      const pRight  = [cx + s, cy];
      const pBottom = [cx, cy + b];
      const pLeft   = [cx - ac, cy];

      const grid = [1,2,3,4,5].map(i=>{
        const rr = (i/max)*r;
        return `<polygon points="${cx},${cy-rr} ${cx+rr},${cy} ${cx},${cy+rr} ${cx-rr},${cy}"
                  fill="none" stroke="rgba(255,255,255,.10)" stroke-width="1"/>`;
      }).join("");

      return `
        <svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" role="img" aria-label="Taste chart">
          ${grid}
          <line x1="${cx}" y1="${cy-r}" x2="${cx}" y2="${cy+r}" stroke="rgba(255,255,255,.12)"/>
          <line x1="${cx-r}" y1="${cy}" x2="${cx+r}" y2="${cy}" stroke="rgba(255,255,255,.12)"/>
          <polygon points="${pTop.join(",")} ${pRight.join(",")} ${pBottom.join(",")} ${pLeft.join(",")}"
                   fill="rgba(215,181,109,.25)" stroke="rgba(215,181,109,.75)" stroke-width="2"/>
          <text x="${cx}" y="${cy-r-8}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Aroma</text>
          <text x="${cx+r+8}" y="${cy+4}" text-anchor="start" font-size="11" fill="rgba(255,255,255,.70)">Sweet/Dry</text>
          <text x="${cx}" y="${cy+r+18}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Body</text>
          <text x="${cx-r-8}" y="${cy+4}" text-anchor="end" font-size="11" fill="rgba(255,255,255,.70)">Acidity</text>
        </svg>
      `;
    }

    // ---------- Firestore shared reviews ----------
    function reviewDocToUi(doc){
      const r = doc.data();
      const d = r.ts?.toDate?.() ?? new Date();
      return {
        id: doc.id,
        name: (r.name || "Guest"),
        rating: Math.max(1, Math.min(5, Number(r.rating)||5)),
        msg: (r.msg || ""),
        dateText: d.toLocaleString()
      };
    }

    function setRatingBadge(avg, count){
      const b = document.getElementById("ratingBadge");
      if (!count){
        b.textContent = "â€”";
        return;
      }
      b.textContent = `â˜… ${avg.toFixed(1)} / 5  (${count})`;
    }

    function renderReviewsShared(list){
      const box = document.getElementById("reviews");
      box.innerHTML = "";

      if (!list || list.length === 0){
        box.innerHTML = `<div class="hint muted">No reviews yet. / ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        setRatingBadge(0, 0);
        return;
      }

      // average
      const sum = list.reduce((a,b)=>a+(b.rating||0),0);
      const avg = sum / list.length;
      setRatingBadge(avg, list.length);

      list.forEach(r => {
        const el = document.createElement("div");
        el.className = "review";
        el.innerHTML = `
          <div class="top">
            <span>${escapeHtml(r.name)} Â· ${escapeHtml(stars(r.rating))}</span>
            <span>${escapeHtml(r.dateText)}</span>
          </div>
          <div class="msg">${escapeHtml(r.msg)}</div>
        `;
        box.appendChild(el);
      });
    }

    let unsubscribeReviews = null;
    let lastReviewsCache = [];

    function listenReviewsShared(sakeId){
      if (!db){
        statusEl.textContent = "Firebase init error / Firebaseè¨­å®šã‚’ç¢ºèª";
        renderReviewsShared([]);
        return;
      }

      // stop old listener
      if (typeof unsubscribeReviews === "function") unsubscribeReviews();

      // Query: sakeId == X, orderBy ts desc, limit N
      // â€» åˆå›ã«ã€Œã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆãŒå¿…è¦ã€ã¨å‡ºãŸã‚‰ã€Firebase Consoleã®æ¡ˆå†…ãƒªãƒ³ã‚¯ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ï¼ˆ1å›ã ã‘ï¼‰ã€‚
      unsubscribeReviews = db.collection(REVIEWS_COLLECTION)
        .where("sakeId", "==", sakeId)
        .orderBy("ts", "desc")
        .limit(REVIEW_LIMIT)
        .onSnapshot(snapshot => {
          const list = [];
          snapshot.forEach(doc => list.push(reviewDocToUi(doc)));
          lastReviewsCache = list;
          renderReviewsShared(list);
        }, err => {
        console.error(err);
        const code = err?.code ? ` (${err.code})` : "";
        const msg  = err?.message ? err.message : String(err);
        statusEl.textContent = `Review load error${code}: ${msg}`;
        });
        
    }

    async function postReviewShared(sakeId, {name, rating, msg}){
      if (!db) throw new Error("Firestore not ready");
      // Basic sanitization / guard rails
      const clean = {
        sakeId: String(sakeId || "").slice(0, 60),
        name: String(name || "Guest").trim().slice(0, 30),
        rating: Math.max(1, Math.min(5, Number(rating)||5)),
        msg: String(msg || "").trim().slice(0, 240),
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        // optional: userAgent for abuse checks later (can be removed)
        ua: navigator.userAgent.slice(0, 120)
      };
      if (!clean.msg) throw new Error("Empty message");
      await db.collection(REVIEWS_COLLECTION).add(clean);
    }

    function exportReviewsJSON(){
      const data = lastReviewsCache.map(r => ({
        name: r.name, rating: r.rating, msg: r.msg, date: r.dateText
      }));
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `reviews_${currentSakeId || "unknown"}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- render list/sheet ----------
    function renderList(items){
      document.getElementById("listCard").style.display = "";
      document.getElementById("countTag").textContent = `${items.length} bottles`;
      const list = document.getElementById("list");
      list.innerHTML = "";
      items.forEach(it=>{
        const card = document.createElement("div");
        card.className = "item";
        const url = `${location.pathname}?id=${encodeURIComponent(it.id)}`;
        card.innerHTML = `
          <div class="n">${escapeHtml(it.name_jp || it.id || "â€”")}</div>
          <div class="s">${escapeHtml(it.name_en || "")}</div>
          <div class="badge">${escapeHtml(it.style_jp || "â€”")} <span class="muted">/</span> ${escapeHtml(it.style_en || "")}</div>
          <div class="go">
            <a class="btn secondary" href="${url}">Open / é–‹ã</a>
          </div>
        `;
        list.appendChild(card);
      });
    }

    function renderSheet(it){
      currentSakeId = it.id;
      document.getElementById("sheetCard").style.display = "";
      document.getElementById("sideCard").style.display = "";

      // title
      document.getElementById("name_jp").textContent = it.name_jp || it.id || "â€”";
      document.getElementById("name_en").textContent = it.name_en || "";
      document.getElementById("idTag").textContent = `id: ${it.id || "â€”"}`;

      // tags
      const tags = document.getElementById("tags");
      tags.innerHTML = "";
      [it.category_jp, it.category_en, it.region_jp, it.region_en].filter(Boolean).slice(0,4).forEach(t=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tags.appendChild(s);
      });

      // KPIs
      document.getElementById("brewery").textContent =
        [it.brewery_jp, it.brewery_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("region").textContent =
        [it.region_jp, it.region_en].filter(Boolean).join(" / ") || "â€”";

      document.getElementById("style").textContent =
        [it.style_jp, it.style_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("rice").textContent =
        [it.rice_jp, it.rice_en].filter(Boolean).join(" / ") || "â€”";

      const abv = it.abv ? `${it.abv}%` : "â€”";
      const smv = it.smv ? `SMV ${it.smv}` : "";
      const acidity = it.acidity_value ? `Acidity ${it.acidity_value}` : "";
      document.getElementById("spec").textContent = [abv, smv, acidity].filter(Boolean).join(" Â· ") || "â€”";

      const polish = it.rice_polish ? `Rice polish ${it.rice_polish}%` : "";
      document.getElementById("polish").textContent = polish || "â€”";

      // table
      document.getElementById("aroma").textContent =
        [it.aroma_jp, it.aroma_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("palate").textContent =
        [it.palate_jp, it.palate_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("pairing").textContent =
        [it.pairing_jp, it.pairing_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("temp").textContent =
        [it.temp_jp, it.temp_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("glass").textContent =
        [it.glass_jp, it.glass_en].filter(Boolean).join(" / ") || "â€”";
      document.getElementById("copy").textContent =
        [it.copy_jp, it.copy_en].filter(Boolean).join(" / ") || "â€”";

      // Visual bars (0â€“5)
      const sweet = setBar("bar_sweet", it.sweet);
      const aroma = setBar("bar_aroma", it.aroma_intensity);
      const body  = setBar("bar_body",  it.body);
      const acid  = setBar("bar_acid",  it.acidity);

      document.getElementById("val_sweet").textContent = sweet.toFixed(0);
      document.getElementById("val_aroma").textContent = aroma.toFixed(0);
      document.getElementById("val_body").textContent  = body.toFixed(0);
      document.getElementById("val_acid").textContent  = acid.toFixed(0);

      document.getElementById("tasteSvgWrap").innerHTML =
        tasteSvg({sweet, aroma, body, acid});

      // Link actions
      const url = new URL(location.href);
      url.searchParams.set("id", it.id);
      document.getElementById("copyLinkBtn").href = url.toString();

      document.getElementById("copyQrTextBtn").onclick = async () => {
        try{
          await navigator.clipboard.writeText(url.toString());
          statusEl.textContent = "Copied URL âœ… / ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ";
        }catch(e){
          statusEl.textContent = "Copy failed / ã‚³ãƒ”ãƒ¼å¤±æ•—";
        }
      };

      // âœ… Shared reviews: start listener
      listenReviewsShared(it.id);

      // Post button
      document.getElementById("submitReviewBtn").onclick = async () => {
        const name = document.getElementById("rv_name").value || "Guest";
        const rating = Number(document.getElementById("rv_rating").value || 5);
        const msg = document.getElementById("rv_msg").value || "";

        try{
          await postReviewShared(it.id, { name, rating, msg });
          document.getElementById("rv_msg").value = "";
          statusEl.textContent = "Posted âœ… / æŠ•ç¨¿ã—ã¾ã—ãŸ";
        } catch (err){
        console.error(err);
        // è¿½åŠ ï¼šåŸå› ã‚’ãã®ã¾ã¾è¡¨ç¤º
        const code = err?.code ? ` (${err.code})` : "";
        const msg  = err?.message ? err.message : String(err);
        statusEl.textContent = `Post failed${code}: ${msg}`;
        }

      };

      document.getElementById("exportReviewsBtn").onclick = () => {
        exportReviewsJSON();
        statusEl.textContent = "Exported âœ… / æ›¸ãå‡ºã—ã¾ã—ãŸ";
      };
    }

    async function main(){
      try{
        // Load CSV
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();
        const items = parseCSV(text);

        statusEl.textContent = `CSV loaded âœ… (${items.length})`;

        // no id => list view
        if(!targetId){
          renderList(items);
          return;
        }

        // id => per bottle view
        const it = items.find(x => String(x.id) === String(targetId));
        if(!it){
          statusEl.textContent = "Not found / éŠ˜æŸ„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
          renderList(items);
          return;
        }
        renderSheet(it);

      }catch(err){
        console.error(err);
        statusEl.textContent = "Load error / èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        document.getElementById("listCard").style.display = "";
        document.getElementById("list").innerHTML =
          `<div class="hint">Could not load <span class="muted">${CSV_PATH}</span>. Put it next to index.html. / åŒéšå±¤ã«sake.csvã‚’ç½®ã„ã¦ãã ã•ã„ã€‚</div>
           <div class="hint muted">â€» file:// ç›´é–‹ãã ã¨ fetch ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Webå…¬é–‹ï¼ˆGitHub Pagesç­‰ï¼‰æ¨å¥¨ã€‚</div>`;
      }
    }

    main();
  </script>

  <!--
  =============================
  Firestore ãƒ«ãƒ¼ãƒ«ä¾‹ï¼ˆæœ€åˆã¯ã“ã‚Œã§OKï¼‰
  =============================
  rules_version = '2';
  service cloud.firestore {
    match /databases/{database}/documents {
      match /reviews/{doc} {
        allow read: if true;
        allow create: if request.resource.data.msg is string
                      && request.resource.data.msg.size() <= 240
                      && request.resource.data.name is string
                      && request.resource.data.name.size() <= 30
                      && request.resource.data.rating in [1,2,3,4,5];
        // å‰Šé™¤/æ›´æ–°ã¯ç®¡ç†è€…ã®ã¿é‹ç”¨ã«ã™ã‚‹ãªã‚‰ã€ã“ã“ã¯ false ã®ã¾ã¾ã§OK
        allow update, delete: if false;
      }
    }
  }

  â€» onSnapshotã§ "index required" ãŒå‡ºãŸã‚‰ã€Firebase Consoleã®æ¡ˆå†…ãƒªãƒ³ã‚¯ã‹ã‚‰
     (sakeId ASC, ts DESC) ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’ä½œæˆã—ã¦ãã ã•ã„ï¼ˆ1å›ã ã‘ï¼‰ã€‚
  -->
</body>
</html>
