<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Sake Council Tokyo | Sake Sheet</title>
  <meta name="description" content="Sake bottle info (JP/EN) with quick visuals + shared reviews." />
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d7b56d;
      --ok:#7ee3a6;
      --warn:#ffcf6b;
      --danger:#ff7a7a;
      --r:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(215,181,109,.10), transparent 60%),
                  radial-gradient(1000px 600px at 90% 15%, rgba(126,227,166,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.45;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 1020px; margin: 0 auto; padding: 18px; }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin: 10px 0 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .name{ font-weight: 780; letter-spacing:.2px; }
    .brand .sub{ color:var(--muted); font-size: 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--line);
      border-radius: 999px; background: rgba(255,255,255,.03);
      font-size: 12px; color: var(--muted);
      white-space:nowrap;
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .title .jp{ font-size: 18px; font-weight: 820; }
    .title .en{ font-size: 12px; color: var(--muted); }
    .tags{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
    .tag{
      font-size: 11px;
      padding: 6px 8px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      color: var(--muted);
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .body{ padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .kpi{
      flex:1; min-width: 170px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .kpi .k{ font-size: 11px; color: var(--muted); display:flex; justify-content:space-between; gap:10px; }
    .kpi .v{ font-size: 14px; font-weight: 760; margin-top: 4px; }
    .mini{ font-size: 11px; color: var(--muted); margin-top: 2px; }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .table th,.table td{
      border-top: 1px solid var(--line);
      padding: 10px 8px;
      vertical-align: top;
    }
    .table th{ text-align:left; color: var(--muted); width: 34%; font-weight: 650; }
    .muted{ color: var(--muted); }

    .viz{ display:grid; grid-template-columns: 1fr; gap: 10px; }

    .bar{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .bar .label{ width: 92px; font-size: 12px; color: var(--muted); }
    .track{
      flex:1; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(215,181,109,.95), rgba(126,227,166,.85));
    }
    .bar .val{ width: 28px; text-align:right; font-size: 12px; color: var(--muted); }

    .chart{
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .chart .caption{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-bottom: 8px;
    }
    .svgwrap{ width:100%; display:flex; justify-content:center; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 11px; color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 8px;
      width: fit-content;
      background: rgba(0,0,0,.12);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button, .btn{
      appearance:none; border:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(215,181,109,.18);
      border: 1px solid rgba(215,181,109,.35);
      color: var(--text);
      font-weight: 740;
      cursor:pointer;
    }
    button.secondary, .btn.secondary{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
    }
    .btn{ display:inline-flex; align-items:center; gap:8px; }
    .hint{ font-size: 11px; color: var(--muted); margin-top: 8px; }

    .story{
      margin-top: 10px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .story .h{ font-size: 11px; color: var(--muted); margin-bottom: 6px; display:flex; justify-content:space-between; gap:10px; }
    .story .p{ font-size: 13px; }

    .reviews{ display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .review{
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .review .top{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
      margin-bottom: 6px;
    }
    .review .msg{ font-size: 13px; }

    .form{
      margin-top: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
    }
    .formgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .formgrid{ grid-template-columns: 1fr; } }
    input, textarea, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .footnote{
      padding: 14px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
      background: rgba(255,255,255,.02);
    }

    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 720px){ .list{ grid-template-columns: 1fr; } }
    .item{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      display:flex; flex-direction:column; gap:8px;
      min-width:0;
    }
    .item .n{ font-weight: 820; }
    .item .s{ color: var(--muted); font-size: 12px; }
    .item .go{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; }

    /* Map block */
    .mapbox{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      overflow:hidden;
    }
    .mapbox .caption{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-bottom: 8px;
    }
    .mapwrap{ width:100%; display:flex; justify-content:center; }

    /* ===== Japan SVG map style (çœŒãƒã‚¤ãƒ©ã‚¤ãƒˆ) ===== */
    .mapwrap svg{
      width:100%;
      max-width: 360px;
      height:auto;
      display:block;
    }
    /* éƒ½é“åºœçœŒã®â€œå¡—ã‚Šå¯¾è±¡â€ã«ä»˜ã‘ã‚‹ã‚¯ãƒ©ã‚¹ï¼ˆpolygon/pathç­‰ï¼‰ */
    .pref{
      fill: rgba(255,255,255,.06);
      stroke: rgba(255,255,255,.18);
      stroke-width: 1;
      transition: .18s ease;
    }
    .pref.dim{ opacity: .40; }
    .pref.active{
      fill: rgba(215,181,109,.78);
      stroke: rgba(215,181,109,.98);
      filter: drop-shadow(0 0 10px rgba(215,181,109,.45));
      opacity: 1;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">The Sake Council Tokyo</div>
        <div class="sub">Sake Bottle Info / éŠ˜æŸ„æƒ…å ±ï¼ˆQRï¼‰</div>
      </div>
      <div class="pill" id="status">Loadingâ€¦</div>
    </header>

    <main class="grid">
      <!-- Left: Sake Sheet -->
      <section class="card" id="sheetCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp" id="name_jp">â€”</div>
            <div class="en" id="name_en">â€”</div>
          </div>
          <div class="tags" id="tags"></div>
        </div>

        <div class="body">
          <div class="row">
            <div class="kpi">
              <div class="k"><span>è”µ / Brewery</span><span class="muted">JP/EN</span></div>
              <div class="v" id="brewery">â€”</div>
              <div class="mini" id="region">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¿ã‚¤ãƒ— / Type</span><span class="muted">Style</span></div>
              <div class="v" id="style">â€”</div>
              <div class="mini" id="rice">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¹ãƒšãƒƒã‚¯ / Spec</span><span class="muted">ABVãƒ»SMV</span></div>
              <div class="v" id="spec">â€”</div>
              <div class="mini" id="polish">â€”</div>
            </div>
          </div>

          <table class="table" aria-label="Sake quick table">
            <tr><th>é¦™ã‚Š / Aroma</th><td id="aroma">â€”</td></tr>
            <tr><th>å‘³ã‚ã„ / Palate</th><td id="palate">â€”</td></tr>
            <tr><th>ç›¸æ€§ / Pairing</th><td id="pairing">â€”</td></tr>
            <tr><th>æ¸©åº¦ / Temp</th><td id="temp">â€”</td></tr>
            <tr><th>ã‚°ãƒ©ã‚¹ / Glass</th><td id="glass">â€”</td></tr>
            <tr><th>ã²ã¨è¨€ / One-liner</th><td id="copy">â€”</td></tr>
          </table>

          <div class="story">
            <div class="h">
              <span>ğŸ“– Story / ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</span>
              <span class="muted" id="storyHint">auto</span>
            </div>
            <div class="p" id="storyText">â€”</div>
          </div>

          <div class="actions">
            <button class="secondary" id="authBtn" type="button">ğŸ‘¤ Start saving / è¨˜éŒ²ã‚’å§‹ã‚ã‚‹</button>
            <button id="saveBtn" type="button">â­ Save / ä¿å­˜</button>
            <button class="secondary" id="unsaveBtn" type="button">âœ¦ Unsave / è§£é™¤</button>
            <a class="btn secondary" id="savedListBtn" href="./index.html">â­ My Saved / ä¿å­˜ä¸€è¦§</a>
          </div>
          <div class="hint" id="saveHint">Tip: ç«¯æœ«ã«ã²ã‚‚ã¥ãã€Œæ—…ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚’ä½œã‚Œã¾ã™ã€‚</div>
        </div>

        <div class="footnote">
          <span>âœ… Reviews are shared across devices (Firestore).</span>
          <span class="muted">æŠ•ç¨¿ã¯å…¨ç«¯æœ«ã«åæ˜ </span>
        </div>
      </section>

      <!-- Right: Visuals + Reviews -->
      <aside class="card" id="sideCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp">ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« / Visual</div>
            <div class="en">Map + taste compass + reviews</div>
          </div>
          <div class="tags">
            <span class="tag" id="idTag">id: â€”</span>
          </div>
        </div>

        <div class="body">
          <div class="viz">
            <!-- Map -->
            <div class="mapbox">
              <div class="caption">
                <span>ğŸ—¾ Origin / ç”£åœ°ãƒãƒƒãƒ—</span>
                <span class="muted" id="mapMeta">â€”</span>
              </div>
              <div class="mapwrap" id="mapWrap"></div>
              <div class="hint muted">â€» éƒ½é“åºœçœŒã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆSVGï¼‰ã€‚å£Šã‚Œã«ããã‚¤ãƒ³ãƒã‚¦ãƒ³ãƒ‰å‘ãã€‚</div>
            </div>

            <!-- Bars -->
            <div class="bar">
              <div class="label">ç”˜è¾› / Sweet-Dry</div>
              <div class="track"><div class="fill" id="bar_sweet"></div></div>
              <div class="val" id="val_sweet">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é¦™ã‚Š / Aroma</div>
              <div class="track"><div class="fill" id="bar_aroma"></div></div>
              <div class="val" id="val_aroma">â€”</div>
            </div>
            <div class="bar">
              <div class="label">ã‚³ã‚¯ / Body</div>
              <div class="track"><div class="fill" id="bar_body"></div></div>
              <div class="val" id="val_body">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é…¸ / Acidity</div>
              <div class="track"><div class="fill" id="bar_acid"></div></div>
              <div class="val" id="val_acid">â€”</div>
            </div>

            <!-- Taste compass -->
            <div class="chart">
              <div class="caption">
                <span>ğŸ§­ Taste Compass / å‘³ã®ç¾…é‡ç›¤</span>
                <span class="muted">0â€“5</span>
              </div>
              <div class="svgwrap" id="tasteSvgWrap"></div>
              <div class="hint muted">â€» CSV: (sweet, aroma_intensity, body, acidity)</div>
            </div>

            <!-- Reviews -->
            <div>
              <div class="row" style="justify-content:space-between; align-items:center;">
                <div class="badge">ğŸ—’ Reviews / ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
                <div class="badge" id="ratingBadge">â€”</div>
              </div>

              <div class="reviews" id="reviews"></div>

              <div class="form" aria-label="Review form">
                <div class="formgrid">
                  <div>
                    <div class="muted" style="font-size:12px; margin:0 0 6px;">Name / ãŠåå‰</div>
                    <input id="rv_name" placeholder="e.g. Alex / ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹" maxlength="30" />
                  </div>
                  <div>
                    <div class="muted" style="font-size:12px; margin:0 0 6px;">Rating / è©•ä¾¡</div>
                    <select id="rv_rating">
                      <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                      <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                      <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                      <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                      <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                    </select>
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <div class="muted" style="font-size:12px; margin:0 0 6px;">Comment / ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                  <textarea id="rv_msg" placeholder="Short impressions / ã²ã¨ã“ã¨æ„Ÿæƒ³ï¼ˆçŸ­ã‚æ¨å¥¨ï¼‰" maxlength="240"></textarea>
                </div>
                <div class="actions" style="margin-top:10px;">
                  <button id="submitReviewBtn" type="button">âœï¸ Post / æŠ•ç¨¿</button>
                  <button class="secondary" id="exportReviewsBtn" type="button">â¬‡ï¸ Export JSON</button>
                </div>
                <div class="hint muted">
                  â€» Save ã¯ç«¯æœ«ã«ã²ã‚‚ã¥ãåŒ¿åã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§OKï¼ˆè¤‡é›‘ãªç™»éŒ²ãªã—ï¼‰ã€‚
                </div>
              </div>
            </div>

          </div>
        </div>
      </aside>

      <!-- List view -->
      <section class="card" id="listCard" style="display:none; grid-column: 1 / -1;">
        <div class="hd">
          <div class="title">
            <div class="jp">éŠ˜æŸ„ä¸€è¦§ / Sake List</div>
            <div class="en">Tap a bottle to open its page.</div>
          </div>
          <div class="tags">
            <span class="tag" id="countTag">â€”</span>
            <span class="tag" id="meTag">me: â€”</span>
          </div>
        </div>
        <div class="body">
          <div class="list" id="list"></div>
          <div class="hint muted">â€» ã“ã®ãƒšãƒ¼ã‚¸ã¯ <span class="muted">?id=xxxx</span> ã§å€‹åˆ¥è¡¨ç¤ºã—ã¾ã™ã€‚</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // =========================
    // Firebaseè¨­å®šï¼ˆè¦å·®ã—æ›¿ãˆï¼‰
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyD1sbz6sLUMf6tabsjwvteEOoQB6vFlcZU",
      authDomain: "the-sake-council-reviews.firebaseapp.com",
      projectId: "the-sake-council-reviews",
    };

    // =========================
    // App settings
    // =========================
    const CSV_PATH = "./sake.csv";
    const JAPAN_SVG_PATH = "./assets/japan_pref.svg";
    const REVIEWS_COLLECTION = "reviews";
    const USERS_COLLECTION   = "users";
    const REVIEW_LIMIT = 60;

    const statusEl = document.getElementById("status");

    const qs = new URLSearchParams(location.search);
    const targetId = qs.get("id");
    let currentSakeId = null;

    // Firebase init
    let db = null;
    let auth = null;
    let me = null;

    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    }catch(e){
      console.error(e);
    }

    // ---------- Saved list ----------
    async function loadMySaved(){
    if (!db) return [];
    me = me || auth?.currentUser || null;
    if (!me) return [];

    const snap = await db
        .collection(USERS_COLLECTION)
        .doc(me.uid)
        .collection("saved")
        .orderBy("savedAt", "desc")
        .limit(200)
        .get();

    const out = [];
    snap.forEach(d => out.push({ id: d.id, ...d.data() }));
    return out;
    }

    function renderSavedSection(saved){
    const listEl = document.getElementById("list");
    if (!listEl) return;

    const wrap = document.createElement("div");
    wrap.style.gridColumn = "1 / -1";
    wrap.style.marginBottom = "10px";

    if (!saved || saved.length === 0){
        wrap.innerHTML = `
        <div class="badge">â­ My Saved / ä¿å­˜ã—ãŸéŠ˜æŸ„</div>
        <div class="hint muted">ã¾ã ä¿å­˜ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å€‹åˆ¥ãƒšãƒ¼ã‚¸ã§ã€ŒSaveã€ã‚’æŠ¼ã™ã¨ã“ã“ã«å‡ºã¾ã™ã€‚</div>
        `;
        listEl.prepend(wrap);
        return;
    }

    const cards = saved.map(s=>{
        const url = `${location.pathname}?id=${encodeURIComponent(s.sakeId || s.id)}`;
        const jp = escapeHtml(s.name_jp || s.sakeId || s.id || "â€”");
        const en = escapeHtml(s.name_en || "");
        const region = escapeHtml(s.region_jp || "");
        const style = escapeHtml(s.style_en || "");
        return `
        <div class="item">
            <div class="n">â­ ${jp}</div>
            <div class="s">${en}</div>
            <div class="badge">${style} Â· <span class="muted">${region}</span></div>
            <div class="go">
            <a class="btn secondary" href="${url}">Open / é–‹ã</a>
            </div>
        </div>
        `;
    }).join("");

    wrap.innerHTML = `
        <div class="row" style="justify-content:space-between;align-items:center;">
        <div class="badge">â­ My Saved / ä¿å­˜ã—ãŸéŠ˜æŸ„</div>
        <div class="badge muted">${saved.length} items</div>
        </div>
        <div class="list" style="margin-top:10px;">${cards}</div>
    `;
    listEl.prepend(wrap);
    }

    // ---------- Helpers ----------
    function clamp01(n){ return Math.max(0, Math.min(1, n)); }
    function toNum(v, fallback=0){
      const n = Number(String(v).replace(/[^\d.-]/g,""));
      return Number.isFinite(n) ? n : fallback;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function stars(n){
      const k = Math.max(1, Math.min(5, Number(n)||0));
      return "â˜…â˜…â˜…â˜…â˜…".slice(0,k) + "â˜†â˜†â˜†â˜†â˜†".slice(0,5-k);
    }
    function jpOrEn(jp, en){
      const a = String(jp||"").trim();
      const b = String(en||"").trim();
      if (a && b) return `${a} / ${b}`;
      return a || b || "â€”";
    }
    function pick(...xs){
      for (const x of xs){
        const s = String(x ?? "").trim();
        if (s) return s;
      }
      return "";
    }

    // ---------- Auth (Anonymous) ----------
    async function ensureAnonAuth(){
      if(!auth) throw new Error("Auth not ready");
      if(auth.currentUser) return auth.currentUser;
      const cred = await auth.signInAnonymously();
      return cred.user;
    }
    function setMeTag(){
      const el = document.getElementById("meTag");
      if (!el) return;
      if (!me) { el.textContent = "me: â€”"; return; }
      el.textContent = `me: ${me.isAnonymous ? "guest" : "user"} Â· ${String(me.uid).slice(0,6)}`;
    }

    // ---------- CSV parsing ----------
    function parseCSV(text){
      const rows = [];
      let cur = "", inQ = false;
      const out = [];
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' && inQ && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQ = !inQ; continue; }
        if (!inQ && ch === ","){ out.push(cur); cur=""; continue; }
        if (!inQ && ch === "\n"){ out.push(cur); rows.push(out.slice()); out.length=0; cur=""; continue; }
        if (ch === "\r") continue;
        cur += ch;
      }
      out.push(cur);
      if (out.some(v => (v ?? "").trim() !== "")) rows.push(out.slice());

      const header = rows.shift().map(h => h.trim());
      return rows
        .filter(r => r.some(v => (v ?? "").trim() !== ""))
        .map(r => {
          const obj = {};
          header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
    }

    // ---------- Taste visuals ----------
    function setBar(elId, value0to5){
      const v = Math.max(0, Math.min(5, toNum(value0to5, 0)));
      const pct = (v/5)*100;
      const el = document.getElementById(elId);
      if (el) el.style.width = pct + "%";
      return v;
    }

    function tasteSvg({sweet, aroma, body, acid}){
      const W=220, H=160, cx=W/2, cy=H/2;
      const max=5, r=58;

      const a = clamp01(aroma/max)*r;
      const s = clamp01(sweet/max)*r;
      const b = clamp01(body/max)*r;
      const ac = clamp01(acid/max)*r;

      const pTop    = [cx, cy - a];
      const pRight  = [cx + s, cy];
      const pBottom = [cx, cy + b];
      const pLeft   = [cx - ac, cy];

      const grid = [1,2,3,4,5].map(i=>{
        const rr = (i/max)*r;
        return `<polygon points="${cx},${cy-rr} ${cx+rr},${cy} ${cx},${cy+rr} ${cx-rr},${cy}"
                  fill="none" stroke="rgba(255,255,255,.10)" stroke-width="1"/>`;
      }).join("");

      return `
        <svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" role="img" aria-label="Taste chart">
          ${grid}
          <line x1="${cx}" y1="${cy-r}" x2="${cx}" y2="${cy+r}" stroke="rgba(255,255,255,.12)"/>
          <line x1="${cx-r}" y1="${cy}" x2="${cx+r}" y2="${cy}" stroke="rgba(255,255,255,.12)"/>
          <polygon points="${pTop.join(",")} ${pRight.join(",")} ${pBottom.join(",")} ${pLeft.join(",")}"
                   fill="rgba(215,181,109,.25)" stroke="rgba(215,181,109,.75)" stroke-width="2"/>
          <text x="${cx}" y="${cy-r-8}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Aroma</text>
          <text x="${cx+r+8}" y="${cy+4}" text-anchor="start" font-size="11" fill="rgba(255,255,255,.70)">Sweet/Dry</text>
          <text x="${cx}" y="${cy+r+18}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Body</text>
          <text x="${cx-r-8}" y="${cy+4}" text-anchor="end" font-size="11" fill="rgba(255,255,255,.70)">Acidity</text>
        </svg>
      `;
    }

    // ---------- Japan SVG Map (Geolonia prefecture svg å¯¾å¿œ) ----------
    function prefectureFromRegionJP(regionJP){
      const s = String(regionJP||"").trim();
      const m = s.match(/(åŒ—æµ·é“|æ±äº¬éƒ½|..åºœ|..çœŒ)/);
      return m ? m[1] : "";
    }

    const PREF_JP_TO_CLASS = {
      "åŒ—æµ·é“":"hokkaido","é’æ£®çœŒ":"aomori","å²©æ‰‹çœŒ":"iwate","å®®åŸçœŒ":"miyagi","ç§‹ç”°çœŒ":"akita","å±±å½¢çœŒ":"yamagata","ç¦å³¶çœŒ":"fukushima",
      "èŒ¨åŸçœŒ":"ibaraki","æ ƒæœ¨çœŒ":"tochigi","ç¾¤é¦¬çœŒ":"gunma","åŸ¼ç‰çœŒ":"saitama","åƒè‘‰çœŒ":"chiba","æ±äº¬éƒ½":"tokyo","ç¥å¥ˆå·çœŒ":"kanagawa",
      "æ–°æ½ŸçœŒ":"niigata","å¯Œå±±çœŒ":"toyama","çŸ³å·çœŒ":"ishikawa","ç¦äº•çœŒ":"fukui","å±±æ¢¨çœŒ":"yamanashi","é•·é‡çœŒ":"nagano",
      "å²é˜œçœŒ":"gifu","é™å²¡çœŒ":"shizuoka","æ„›çŸ¥çœŒ":"aichi","ä¸‰é‡çœŒ":"mie","æ»‹è³€çœŒ":"shiga","äº¬éƒ½åºœ":"kyoto","å¤§é˜ªåºœ":"osaka",
      "å…µåº«çœŒ":"hyogo","å¥ˆè‰¯çœŒ":"nara","å’Œæ­Œå±±çœŒ":"wakayama",
      "é³¥å–çœŒ":"tottori","å³¶æ ¹çœŒ":"shimane","å²¡å±±çœŒ":"okayama","åºƒå³¶çœŒ":"hiroshima","å±±å£çœŒ":"yamaguchi",
      "å¾³å³¶çœŒ":"tokushima","é¦™å·çœŒ":"kagawa","æ„›åª›çœŒ":"ehime","é«˜çŸ¥çœŒ":"kochi",
      "ç¦å²¡çœŒ":"fukuoka","ä½è³€çœŒ":"saga","é•·å´çœŒ":"nagasaki","ç†Šæœ¬çœŒ":"kumamoto","å¤§åˆ†çœŒ":"oita","å®®å´çœŒ":"miyazaki",
      "é¹¿å…å³¶çœŒ":"kagoshima","æ²–ç¸„çœŒ":"okinawa",
    };

    let japanSvgEl = null;

    function getPrefGroups(svg){
      return Array.from(svg.querySelectorAll("g.prefecture"));
    }

    function markPrefShapes(svg){
      // Geolonia ã®éƒ½é“åºœçœŒã¯ g.prefecture ã®ä¸­ã« polygon/path ãŒå…¥ã£ã¦ã„ã‚‹ã®ã§ã€ãã‚Œã‚‰ã‚’å¡—ã‚Šå¯¾è±¡ã«ã™ã‚‹
      const groups = getPrefGroups(svg);
      groups.forEach(g=>{
        // title ã‹ã‚‰æ—¥æœ¬èªçœŒåã‚’å–ã£ã¦ data-jp ã«ä¿æŒã—ã¦ãŠãï¼ˆä¾‹: "å¥ˆè‰¯ / Nara" â†’ "å¥ˆè‰¯"ï¼‰
        const title = g.querySelector("title")?.textContent || "";
        const jpName = title.split("/")[0].trim(); // "å¥ˆè‰¯"
        if (jpName) g.dataset.jp = jpName;

        g.querySelectorAll("path, polygon").forEach(shape=>{
          shape.classList.add("pref");
        });
      });
    }

    async function loadJapanMapSvg(){
      const res = await fetch(JAPAN_SVG_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("SVG fetch failed: " + res.status);
      const svgText = await res.text();

      const wrap = document.getElementById("mapWrap");
      wrap.innerHTML = svgText;

      const svg = wrap.querySelector("svg");
      if(!svg) throw new Error("SVG not found inside mapWrap");

      markPrefShapes(svg);

      japanSvgEl = svg;
      return svg;
    }

    function findPrefGroup(svg, prefJpWithSuffix){
      if(!svg || !prefJpWithSuffix) return null;

      // ä¾‹: "å¥ˆè‰¯çœŒ" â†’ "å¥ˆè‰¯"
      const prefShort = prefJpWithSuffix
        .replace("éƒ½","")
        .replace("é“","")
        .replace("åºœ","")
        .replace("çœŒ","");

      // 1) class ã§æ¢ã™ï¼ˆGeoloniaã¯ g.prefecture ãŒ "nara" ã¿ãŸã„ãªã‚¯ãƒ©ã‚¹ã‚’æŒã¤ï¼‰
      const cls = PREF_JP_TO_CLASS[prefJpWithSuffix];
      if (cls){
        const byClass = svg.querySelector(`g.prefecture.${CSS.escape(cls)}`);
        if (byClass) return byClass;
      }

      // 2) title / data-jp ã§æ¢ã™ï¼ˆä¾‹: <title>å¥ˆè‰¯ / Nara</title>ï¼‰
      const groups = getPrefGroups(svg);
      for(const g of groups){
        const jp = (g.dataset.jp || "").trim();
        if (jp === prefShort) return g;
        const title = g.querySelector("title")?.textContent || "";
        if (title.includes(prefShort)) return g;
      }

      // 3) data-code ã§æ¢ã—ãŸã„å ´åˆã¯ã“ã“ã«è¿½åŠ ï¼ˆå¿…è¦ãªã‚‰ï¼‰
      return null;
    }

    function highlightPrefOnMap(prefJp){
      const meta = document.getElementById("mapMeta");
      if(meta) meta.textContent = prefJp || "â€”";

      if(!japanSvgEl) return;
      const svg = japanSvgEl;

      // resetï¼ˆå…¨éƒ¨ã®å¡—ã‚Šå¯¾è±¡ã‚’æˆ»ã™ï¼‰
      svg.querySelectorAll(".pref").forEach(el=>{
        el.classList.remove("active");
        el.classList.remove("dim");
      });

      if(!prefJp) return;

      const group = findPrefGroup(svg, prefJp);
      if(!group){
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯å£Šã•ãªã„ï¼ˆåœ°å›³ã ã‘æ³¨æ„ï¼‰
        console.warn("Map: prefecture not matched:", prefJp);
        return;
      }

      // ã¾ãšå…¨éƒ¨ dimã€æ¬¡ã«å¯¾è±¡ã ã‘ active
      svg.querySelectorAll(".pref").forEach(el=> el.classList.add("dim"));

      group.querySelectorAll("path.pref, polygon.pref").forEach(shape=>{
        shape.classList.remove("dim");
        shape.classList.add("active");
      });
    }

    // ---------- Collection (Save/Unsave) ----------
    async function saveBottle(sakeId, bottleMeta){
      if (!db) throw new Error("Firestore not ready");
      if (!me) throw new Error("Not signed in");
      const ref = db.collection(USERS_COLLECTION).doc(me.uid).collection("saved").doc(String(sakeId));
      await ref.set({
        sakeId: String(sakeId),
        name_jp: bottleMeta?.name_jp || "",
        name_en: bottleMeta?.name_en || "",
        region_jp: bottleMeta?.region_jp || "",
        style_en: bottleMeta?.style_en || "",
        savedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }

    async function unsaveBottle(sakeId){
      if (!db) throw new Error("Firestore not ready");
      if (!me) throw new Error("Not signed in");
      const ref = db.collection(USERS_COLLECTION).doc(me.uid).collection("saved").doc(String(sakeId));
      await ref.delete();
    }

    async function isSavedBottle(sakeId){
      if (!db || !me) return false;
      const ref = db.collection(USERS_COLLECTION).doc(me.uid).collection("saved").doc(String(sakeId));
      const snap = await ref.get();
      return snap.exists;
    }

    // ---------- Shared reviews ----------
    function reviewDocToUi(doc){
      const r = doc.data();
      const d = r.ts?.toDate?.() ?? new Date();
      return {
        id: doc.id,
        name: (r.name || "Guest"),
        rating: Math.max(1, Math.min(5, Number(r.rating)||5)),
        msg: (r.msg || ""),
        dateText: d.toLocaleString()
      };
    }

    function setRatingBadge(avg, count){
      const b = document.getElementById("ratingBadge");
      if (!count){ b.textContent = "â€”"; return; }
      b.textContent = `â˜… ${avg.toFixed(1)} / 5  (${count})`;
    }

    function renderReviewsShared(list){
      const box = document.getElementById("reviews");
      box.innerHTML = "";

      if (!list || list.length === 0){
        box.innerHTML = `<div class="hint muted">No reviews yet. / ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        setRatingBadge(0, 0);
        return;
      }

      const sum = list.reduce((a,b)=>a+(b.rating||0),0);
      const avg = sum / list.length;
      setRatingBadge(avg, list.length);

      list.forEach(r => {
        const el = document.createElement("div");
        el.className = "review";
        el.innerHTML = `
          <div class="top">
            <span>${escapeHtml(r.name)} Â· ${escapeHtml(stars(r.rating))}</span>
            <span>${escapeHtml(r.dateText)}</span>
          </div>
          <div class="msg">${escapeHtml(r.msg)}</div>
        `;
        box.appendChild(el);
      });
    }

    let unsubscribeReviews = null;
    let lastReviewsCache = [];

    async function listenReviewsShared(sakeId){
      try{
        me = await ensureAnonAuth();
        setMeTag();
      }catch(e){
        console.error(e);
        statusEl.textContent = "Auth error / èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆAnonymousæœ‰åŠ¹åŒ–ã‚’ç¢ºèªï¼‰";
        return;
      }

      if (!db){
        statusEl.textContent = "Firebase init error / Firebaseè¨­å®šã‚’ç¢ºèª";
        renderReviewsShared([]);
        return;
      }
      if (typeof unsubscribeReviews === "function") unsubscribeReviews();

      unsubscribeReviews = db.collection(REVIEWS_COLLECTION)
        .where("sakeId", "==", sakeId)
        .orderBy("ts", "desc")
        .limit(REVIEW_LIMIT)
        .onSnapshot(snapshot => {
          const list = [];
          snapshot.forEach(doc => list.push(reviewDocToUi(doc)));
          lastReviewsCache = list;
          renderReviewsShared(list);
        }, err => {
          console.error(err);
          const code = err?.code ? ` (${err.code})` : "";
          const msg  = err?.message ? err.message : String(err);
          statusEl.textContent = `Review load error${code}: ${msg}`;
        });
    }

    async function postReviewShared(sakeId, {name, rating, msg}){
      me = me || await ensureAnonAuth();
      if (!db) throw new Error("Firestore not ready");

      const clean = {
        sakeId: String(sakeId || "").slice(0, 60),
        name: String(name || "Guest").trim().slice(0, 30),
        rating: Math.max(1, Math.min(5, Number(rating)||5)),
        msg: String(msg || "").trim().slice(0, 240),
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        uid: String(me?.uid || "anon").slice(0, 80),
      };
      if (!clean.msg) throw new Error("Empty message");
      await db.collection(REVIEWS_COLLECTION).add(clean);
    }

    function exportReviewsJSON(){
      const data = lastReviewsCache.map(r => ({
        name: r.name, rating: r.rating, msg: r.msg, date: r.dateText
      }));
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `reviews_${currentSakeId || "unknown"}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Story (auto) ----------
    function buildStory(it){
      const region = pick(it.region_en, it.region_jp);
      const brewery = pick(it.brewery_en, it.brewery_jp);
      const style = pick(it.style_en, it.style_jp);
      const rice = pick(it.rice_en, it.rice_jp);
      const aroma = pick(it.aroma_en, it.aroma_jp);
      const palate = pick(it.palate_en, it.palate_jp);

      const en = `${region} Â· ${brewery}. A ${style} sake${rice ? ` using ${rice}` : ""}. ${aroma ? `Aroma: ${aroma}.` : ""} ${palate ? `Palate: ${palate}.` : ""}`.replace(/\s+/g," ").trim();
      const jp = `${pick(it.region_jp,it.region_en)}ã®${pick(it.brewery_jp,it.brewery_en)}ã€‚${pick(it.style_jp,it.style_en)}${it.rice_jp ? `ï¼ˆ${it.rice_jp}ï¼‰` : ""}ã®é­…åŠ›ã€‚${it.aroma_jp ? `é¦™ã‚Šï¼š${it.aroma_jp}ã€‚` : ""}${it.palate_jp ? `å‘³ã‚ã„ï¼š${it.palate_jp}ã€‚` : ""}`.replace(/\s+/g," ").trim();

      return jpOrEn(jp, en);
    }

    // ---------- render list/sheet ----------
    function renderList(items){
      document.getElementById("listCard").style.display = "";
      document.getElementById("countTag").textContent = `${items.length} bottles`;

      const list = document.getElementById("list");
      list.innerHTML = "";

      items.forEach(it=>{
        const card = document.createElement("div");
        card.className = "item";
        const url = `${location.pathname}?id=${encodeURIComponent(it.id)}`;
        const type = pick(it["åˆ†é¡ã‚¿ã‚¤ãƒ—"], it.style_en, it.style_jp, "â€”");
        const region = pick(it.region_en, it.region_jp, "â€”");
        card.innerHTML = `
          <div class="n">${escapeHtml(it.name_jp || it.id || "â€”")}</div>
          <div class="s">${escapeHtml(it.name_en || "")}</div>
          <div class="badge">${escapeHtml(type)} Â· <span class="muted">${escapeHtml(region)}</span></div>
          <div class="go">
            <a class="btn secondary" href="${url}">Open / é–‹ã</a>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function renderSheet(it){
      currentSakeId = it.id;
      document.getElementById("sheetCard").style.display = "";
      document.getElementById("sideCard").style.display = "";

      document.getElementById("name_jp").textContent = it.name_jp || it.id || "â€”";
      document.getElementById("name_en").textContent = it.name_en || "";
      document.getElementById("idTag").textContent = `id: ${it.id || "â€”"}`;

      const tags = document.getElementById("tags");
      tags.innerHTML = "";
      [
        pick(it["åˆ†é¡ã‚¿ã‚¤ãƒ—"], it.style_en, it.style_jp),
        pick(it.category_en, it.category_jp),
        pick(it.region_en, it.region_jp),
        pick(it.brewery_en, it.brewery_jp),
      ].filter(Boolean).slice(0,4).forEach(t=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tags.appendChild(s);
      });

      document.getElementById("brewery").textContent = jpOrEn(it.brewery_jp, it.brewery_en);
      document.getElementById("region").textContent  = jpOrEn(it.region_jp, it.region_en);

      document.getElementById("style").textContent   = jpOrEn(it.style_jp, it.style_en);
      document.getElementById("rice").textContent    = jpOrEn(it.rice_jp, it.rice_en);

      const abv = it.abv ? `${it.abv}%` : "";
      const smv = it.smv ? `SMV ${it.smv}` : "";
      const acidityValue = it.acidity_value ? `Acidity ${it.acidity_value}` : "";
      document.getElementById("spec").textContent = [abv, smv, acidityValue].filter(Boolean).join(" Â· ") || "â€”";
      document.getElementById("polish").textContent = it.rice_polish ? `Rice polish ${it.rice_polish}%` : "â€”";

      document.getElementById("aroma").textContent   = jpOrEn(it.aroma_jp, it.aroma_en);
      document.getElementById("palate").textContent  = jpOrEn(it.palate_jp, it.palate_en);
      document.getElementById("pairing").textContent = jpOrEn(it.pairing_jp, it.pairing_en);
      document.getElementById("temp").textContent    = jpOrEn(it.temp_jp, it.temp_en);
      document.getElementById("glass").textContent   = jpOrEn(it.glass_jp, it.glass_en);
      document.getElementById("copy").textContent    = jpOrEn(it.copy_jp, it.copy_en);

      // Story
      document.getElementById("storyText").textContent = buildStory(it);
      document.getElementById("storyHint").textContent = "auto";

      // Visual bars (0â€“5)
      const sweet = setBar("bar_sweet", it.sweet);
      const aroma = setBar("bar_aroma", it.aroma_intensity);
      const body  = setBar("bar_body",  it.body);
      const acid  = setBar("bar_acid",  it.acidity);

      document.getElementById("val_sweet").textContent = sweet.toFixed(0);
      document.getElementById("val_aroma").textContent = aroma.toFixed(0);
      document.getElementById("val_body").textContent  = body.toFixed(0);
      document.getElementById("val_acid").textContent  = acid.toFixed(0);

      document.getElementById("tasteSvgWrap").innerHTML = tasteSvg({sweet, aroma, body, acid});

      // âœ… Map highlightï¼ˆSVGï¼‰
      const pref = prefectureFromRegionJP(it.region_jp || "");
      highlightPrefOnMap(pref);

      // Auth / Save UI
      const authBtn = document.getElementById("authBtn");
      const saveBtn = document.getElementById("saveBtn");
      const unsaveBtn = document.getElementById("unsaveBtn");

      authBtn.onclick = async () => {
        try{
          me = await ensureAnonAuth();
          setMeTag();
          statusEl.textContent = "Ready âœ… / è¨˜éŒ²ã§ãã¾ã™";
        }catch(e){
          console.error(e);
          statusEl.textContent = "Auth error / èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆAnonymousæœ‰åŠ¹åŒ–ã‚’ç¢ºèªï¼‰";
        }
      };

    saveBtn.onclick = async () => {
    try{
        me = me || await ensureAnonAuth();
        await saveBottle(it.id, it);
        statusEl.textContent = "Saved â­ / ä¿å­˜ã—ã¾ã—ãŸ";
        document.getElementById("saveHint").textContent = "â­ Saved. ã“ã®éŠ˜æŸ„ã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å…¥ã£ã¦ã„ã¾ã™ã€‚";
    }catch(e){
        console.error(e);
        const code = e?.code ? ` (${e.code})` : "";
        const msg  = e?.message ? e.message : String(e);
        statusEl.textContent = `Save failed${code}: ${msg}`;
    }
    };

      unsaveBtn.onclick = async () => {
        try{
          me = me || await ensureAnonAuth();
          await unsaveBottle(it.id);
          statusEl.textContent = "Removed / è§£é™¤ã—ã¾ã—ãŸ";
          document.getElementById("saveHint").textContent = "Tip: Save ã™ã‚‹ã¨â€œæ—…ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³â€ã«æ®‹ã›ã¾ã™ã€‚";
        }catch(e){
          console.error(e);
          statusEl.textContent = "Remove failed / è§£é™¤å¤±æ•—";
        }
      };

    // âœ… Savedä¸€è¦§ã¸ï¼ˆå€‹åˆ¥ãƒšãƒ¼ã‚¸ã‹ã‚‰ï¼‰
    const savedListBtn = document.getElementById("savedListBtn");
    if (savedListBtn){
    savedListBtn.onclick = async (e) => {
        e.preventDefault();
        try{
        me = me || await ensureAnonAuth(); // å…ˆã«åŒ¿åUIDã‚’ç¢ºå®š
        setMeTag();
        }catch(_){}
        location.href = "./index.html"; // ?idç„¡ã—ã¸
    };
    }
    
      // Reviews: start listener
      listenReviewsShared(it.id);

      // Post button
      document.getElementById("submitReviewBtn").onclick = async () => {
        const name = document.getElementById("rv_name").value || "Guest";
        const rating = Number(document.getElementById("rv_rating").value || 5);
        const msg = document.getElementById("rv_msg").value || "";
        try{
          me = me || await ensureAnonAuth();
          await postReviewShared(it.id, { name, rating, msg });
          document.getElementById("rv_msg").value = "";
          statusEl.textContent = "Posted âœ… / æŠ•ç¨¿ã—ã¾ã—ãŸ";
        }catch(err){
          console.error(err);
          const code = err?.code ? ` (${err.code})` : "";
          const m  = err?.message ? err.message : String(err);
          statusEl.textContent = `Post failed${code}: ${m}`;
        }
      };

      document.getElementById("exportReviewsBtn").onclick = () => {
        exportReviewsJSON();
        statusEl.textContent = "Exported âœ… / æ›¸ãå‡ºã—ã¾ã—ãŸ";
      };

      // show save state
      try{
        if (auth?.currentUser) me = auth.currentUser;
        if (me && it.id){
          const saved = await isSavedBottle(it.id);
          document.getElementById("saveHint").textContent = saved
            ? "â­ Saved. ã“ã®éŠ˜æŸ„ã¯ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«å…¥ã£ã¦ã„ã¾ã™ã€‚"
            : "Tip: Save ã™ã‚‹ã¨â€œæ—…ã®ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³â€ã«æ®‹ã›ã¾ã™ã€‚";
        }
      }catch(_){}
    }

    async function main(){
      try{
        if (auth){
          auth.onAuthStateChanged(u => {
            me = u || null;
            setMeTag();
          });
        }

        // load map svg early
        try{
          await loadJapanMapSvg();
        }catch(e){
          console.error(e);
          statusEl.textContent = "Map load error / japan_pref.svg ã‚’ç¢ºèª";
        }

        // load CSV
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();
        const items = parseCSV(text);

        statusEl.textContent = `CSV loaded âœ… (${items.length})`;

        if(!targetId){
        renderList(items);

        // â˜… Savedè¡¨ç¤ºï¼šãƒ­ã‚°ã‚¤ãƒ³ã§ãã¦ã„ã‚Œã°èª­ã¿è¾¼ã‚“ã§ä¸Šã«è¡¨ç¤º
        try{
            me = await ensureAnonAuth();
            setMeTag();
            const saved = await loadMySaved();
            renderSavedSection(saved);
        }catch(e){
            // ã“ã“ã§å¤±æ•—ã—ã¦ã‚‚é€šå¸¸ã®ä¸€è¦§ã¯è¦‹ã›ã‚‹
            console.warn("saved load skipped", e);
        }

        return;
        }


        const it = items.find(x => String(x.id) === String(targetId));
        if(!it){
          statusEl.textContent = "Not found / éŠ˜æŸ„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
          renderList(items);
          return;
        }

        await renderSheet(it);

      }catch(err){
        console.error(err);
        statusEl.textContent = "Load error / èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        document.getElementById("listCard").style.display = "";
        document.getElementById("list").innerHTML =
          `<div class="hint">Could not load <span class="muted">${escapeHtml(CSV_PATH)}</span>. Put it next to index.html. / åŒéšå±¤ã«sake.csvã‚’ç½®ã„ã¦ãã ã•ã„ã€‚</div>
           <div class="hint muted">â€» file:// ç›´é–‹ãã ã¨ fetch ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Webå…¬é–‹ï¼ˆGitHub Pagesç­‰ï¼‰æ¨å¥¨ã€‚</div>`;
      }
    }

    main();
  </script>
</body>
</html>
