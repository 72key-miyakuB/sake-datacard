<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Sake Council Tokyo | Sake Sheet</title>
  <meta name="description" content="Sake bottle info (JP/EN) with quick visuals + shared reviews." />
  <style>
    :root{
      --bg:#0b0d12;
      --panel: rgba(255,255,255,.06);
      --panel2: rgba(255,255,255,.09);
      --line: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --accent:#d7b56d;
      --ok:#7ee3a6;
      --warn:#ffcf6b;
      --danger:#ff7a7a;
      --r:18px;
      --shadow: 0 14px 40px rgba(0,0,0,.45);
      --font: ui-sans-serif, system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% 0%, rgba(215,181,109,.10), transparent 60%),
                  radial-gradient(1000px 600px at 90% 15%, rgba(126,227,166,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family:var(--font);
      line-height:1.45;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: 1020px; margin: 0 auto; padding: 18px; }
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      margin: 10px 0 14px;
    }
    .brand{ display:flex; flex-direction:column; gap:2px; }
    .brand .name{ font-weight: 780; letter-spacing:.2px; }
    .brand .sub{ color:var(--muted); font-size: 12px; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 10px; border: 1px solid var(--line);
      border-radius: 999px; background: rgba(255,255,255,.03);
      font-size: 12px; color: var(--muted);
      white-space:nowrap;
    }
    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap: 14px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    }
    .title{ display:flex; flex-direction:column; gap:4px; min-width: 0; }
    .title .jp{ font-size: 18px; font-weight: 820; }
    .title .en{ font-size: 12px; color: var(--muted); }
    .tags{ display:flex; flex-wrap:wrap; gap:6px; justify-content:flex-end; }
    .tag{
      font-size: 11px;
      padding: 6px 8px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      color: var(--muted);
      max-width: 100%;
      overflow:hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .body{ padding: 14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .kpi{
      flex:1; min-width: 170px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .kpi .k{ font-size: 11px; color: var(--muted); display:flex; justify-content:space-between; gap:10px; }
    .kpi .v{ font-size: 14px; font-weight: 760; margin-top: 4px; }
    .mini{ font-size: 11px; color: var(--muted); margin-top: 2px; }

    .table{
      width:100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 13px;
    }
    .table th,.table td{
      border-top: 1px solid var(--line);
      padding: 10px 8px;
      vertical-align: top;
    }
    .table th{ text-align:left; color: var(--muted); width: 34%; font-weight: 650; }
    .muted{ color: var(--muted); }

    .viz{ display:grid; grid-template-columns: 1fr; gap: 10px; }

    .bar{
      display:flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .bar .label{ width: 108px; font-size: 12px; color: var(--muted); }
    .track{
      flex:1; height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,.08);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.08);
    }
    .fill{
      height:100%;
      width: 50%;
      background: linear-gradient(90deg, rgba(215,181,109,.95), rgba(126,227,166,.85));
    }
    .bar .val{ width: 28px; text-align:right; font-size: 12px; color: var(--muted); }

    .chart{
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
    }
    .chart .caption{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-bottom: 8px;
    }
    .svgwrap{ width:100%; display:flex; justify-content:center; }

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      font-size: 11px; color: var(--muted);
      border: 1px solid var(--line);
      border-radius: 999px;
      padding: 6px 8px;
      width: fit-content;
      background: rgba(0,0,0,.12);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button, .btn{
      appearance:none; border:none;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(215,181,109,.18);
      border: 1px solid rgba(215,181,109,.35);
      color: var(--text);
      font-weight: 740;
      cursor:pointer;
    }
    button.secondary, .btn.secondary{
      background: rgba(255,255,255,.05);
      border: 1px solid var(--line);
      color: var(--text);
      font-weight: 650;
    }
    .btn{ display:inline-flex; align-items:center; gap:8px; }
    .hint{ font-size: 11px; color: var(--muted); margin-top: 8px; }

    .story{
      margin-top: 10px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .story .h{ font-size: 11px; color: var(--muted); margin-bottom: 6px; display:flex; justify-content:space-between; gap:10px; }
    .story .p{ font-size: 13px; }

    /* Reviews */
    .reviews{ display:flex; flex-direction:column; gap:10px; margin-top: 12px; }
    .review{
      border: 1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .review .top{
      display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap;
      font-size: 12px; color: var(--muted);
      margin-bottom: 6px;
    }
    .review .msg{ font-size: 13px; }

    .form{
      margin-top: 10px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 12px;
    }
    .formgrid{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 560px){ .formgrid{ grid-template-columns: 1fr; } }
    input, textarea, select{
      width:100%;
      padding: 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-family: var(--font);
      font-size: 14px;
      outline:none;
    }
    textarea{ min-height: 84px; resize: vertical; }

    .footnote{
      padding: 14px;
      border-top: 1px solid var(--line);
      font-size: 12px;
      color: var(--muted);
      display:flex; justify-content:space-between; flex-wrap:wrap; gap:10px;
      background: rgba(255,255,255,.02);
    }

    /* List */
    .list{
      display:grid;
      grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    @media (max-width: 720px){ .list{ grid-template-columns: 1fr; } }
    .item{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      display:flex; flex-direction:column; gap:8px;
      min-width:0;
    }
    .item .n{ font-weight: 820; }
    .item .s{ color: var(--muted); font-size: 12px; }
    .item .go{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; }

    /* Map block */
    .mapbox{
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(255,255,255,.03);
      padding: 12px;
      overflow:hidden;
    }
    .mapbox .caption{
      display:flex; justify-content:space-between; align-items:center;
      font-size:12px; color: var(--muted); margin-bottom: 8px;
    }
    .mapwrap{ width:100%; display:flex; justify-content:center; }

    /* ===== Japan SVG map style (çœŒãƒã‚¤ãƒ©ã‚¤ãƒˆ) ===== */
    .mapwrap svg{
      width:100%;
      max-width: 360px;
      height:auto;
      display:block;
    }
    .pref{
      fill: rgba(255,255,255,.06);
      stroke: rgba(255,255,255,.18);
      stroke-width: 1;
      transition: .18s ease;
    }
    .pref.dim{ opacity: .40; }
    .pref.active{
      fill: rgba(215,181,109,.78);
      stroke: rgba(215,181,109,.98);
      filter: drop-shadow(0 0 10px rgba(215,181,109,.45));
      opacity: 1;
    }

    /* --- Review header (make it standout) --- */
    .reviewHead{
      border: 1px solid rgba(215,181,109,.35);
      background: rgba(215,181,109,.08);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .reviewHead .h1{
      font-size: 16px;
      font-weight: 900;
      letter-spacing: .2px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 6px;
    }
    .reviewHead .desc{
      font-size: 12px;
      color: var(--muted);
      margin:0;
      line-height: 1.6;
    }
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 10px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="name">The Sake Council Tokyo</div>
        <div class="sub">Sake Bottle Info / éŠ˜æŸ„æƒ…å ±ï¼ˆQRï¼‰</div>
      </div>
      <div class="pill" id="status">Loadingâ€¦</div>
    </header>

    <main class="grid">
      <!-- Left: Sake Sheet -->
      <section class="card" id="sheetCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp" id="name_jp">â€”</div>
            <div class="en" id="name_en">â€”</div>
          </div>
          <div class="tags" id="tags"></div>
        </div>

        <div class="body">
          <div class="row">
            <div class="kpi">
              <div class="k"><span>è”µ / Brewery</span><span class="muted">JP/EN</span></div>
              <div class="v" id="brewery">â€”</div>
              <div class="mini" id="region">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¿ã‚¤ãƒ— / Type</span><span class="muted">Style</span></div>
              <div class="v" id="style">â€”</div>
              <div class="mini" id="rice">â€”</div>
            </div>
            <div class="kpi">
              <div class="k"><span>ã‚¹ãƒšãƒƒã‚¯ / Spec</span><span class="muted">ABVãƒ»SMV</span></div>
              <div class="v" id="spec">â€”</div>
              <div class="mini" id="polish">â€”</div>
            </div>
          </div>

          <table class="table" aria-label="Sake quick table">
            <tr><th>é¦™ã‚Š / Aroma</th><td id="aroma">â€”</td></tr>
            <tr><th>å‘³ã‚ã„ / Palate</th><td id="palate">â€”</td></tr>
            <tr><th>ç›¸æ€§ / Pairing</th><td id="pairing">â€”</td></tr>
            <tr><th>æ¸©åº¦ / Temp</th><td id="temp">â€”</td></tr>
            <tr><th>ã‚°ãƒ©ã‚¹ / Glass</th><td id="glass">â€”</td></tr>
            <tr><th>ã²ã¨è¨€ / One-liner</th><td id="copy">â€”</td></tr>
          </table>

          <div class="story">
            <div class="h">
              <span>ğŸ“– Story / ã‚¹ãƒˆãƒ¼ãƒªãƒ¼</span>
              <span class="muted" id="storyHint">auto</span>
            </div>
            <div class="p" id="storyText">â€”</div>
          </div>

          <div class="actions">
            <a class="btn secondary" id="myPageBtn" href="./index.html">â­ My Page / å±¥æ­´ã‚’è¦‹ã‚‹</a>
          </div>
          <div class="hint" id="myPageHint">â€» ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿æ™‚ã«ç™»éŒ²ã—ãŸåå‰ã§ã€æ¬¡ã®QRã§ã‚‚ç¶šãã‹ã‚‰æ›¸ã‘ã¾ã™ã€‚</div>
        </div>

        <div class="footnote">
          <span>âœ… Reviews are shared across devices (Firestore).</span>
          <span class="muted">æŠ•ç¨¿ã¯å…¨ç«¯æœ«ã«åæ˜ </span>
        </div>
      </section>

      <!-- Right: Map + Taste + Reviews -->
      <aside class="card" id="sideCard" style="display:none;">
        <div class="hd">
          <div class="title">
            <div class="jp">ãƒ†ã‚¤ã‚¹ãƒ†ã‚£ãƒ³ã‚° / Tasting</div>
            <div class="en">Origin map + taste guide + reviews</div>
          </div>
          <div class="tags">
            <span class="tag" id="idTag">id: â€”</span>
          </div>
        </div>

        <div class="body">
          <div class="viz">
            <!-- Map -->
            <div class="mapbox">
              <div class="caption">
                <span>ğŸ—¾ Origin / ç”£åœ°</span>
                <span class="muted" id="mapMeta">â€”</span>
              </div>
              <div class="mapwrap" id="mapWrap"></div>
              <div class="hint muted">â€» çœŒã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤ºï¼ˆå£Šã‚Œã«ãã„SVGï¼‰</div>
            </div>

            <!-- Bars -->
            <div class="bar">
              <div class="label">ç”˜è¾› / Sweet-Dry</div>
              <div class="track"><div class="fill" id="bar_sweet"></div></div>
              <div class="val" id="val_sweet">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é¦™ã‚Š / Aroma</div>
              <div class="track"><div class="fill" id="bar_aroma"></div></div>
              <div class="val" id="val_aroma">â€”</div>
            </div>
            <div class="bar">
              <div class="label">ã‚³ã‚¯ / Body</div>
              <div class="track"><div class="fill" id="bar_body"></div></div>
              <div class="val" id="val_body">â€”</div>
            </div>
            <div class="bar">
              <div class="label">é…¸ / Acidity</div>
              <div class="track"><div class="fill" id="bar_acid"></div></div>
              <div class="val" id="val_acid">â€”</div>
            </div>

            <!-- Taste compass -->
            <div class="chart">
              <div class="caption">
                <span>ğŸ§­ Taste Compass / å‘³ã®ç¾…é‡ç›¤</span>
                <span class="muted">0â€“5</span>
              </div>
              <div class="svgwrap" id="tasteSvgWrap"></div>
              <div class="hint muted">â€» CSV: (sweet, aroma_intensity, body, acidity)</div>
            </div>

            <!-- Reviews -->
            <div class="reviewHead">
              <div class="h1">
                <span>âœï¸ Reviews / æ„Ÿæƒ³ã‚’æ›¸ããƒ»èª­ã‚€</span>
                <span class="badge" id="ratingBadge">â€”</span>
              </div>
              <p class="desc">
                åˆå›ã¯ã€ŒãŠåå‰ã€ã‚’å…¥ã‚Œã¦æŠ•ç¨¿ã™ã‚‹ã¨ã€ãã®åå‰ãŒã“ã®ç«¯æœ«ã«ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆé¢å€’ãªä¼šå“¡ç™»éŒ²ãªã—ï¼‰ã€‚<br/>
                æ¬¡ã«åˆ¥ã®QRã‚’èª­ã‚“ã§ã‚‚åŒã˜åå‰ã§ç¶šã‘ã¦æŠ•ç¨¿ã§ãã¾ã™ã€‚æŠ•ç¨¿ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯åº—å†…ã®å…¨å“¡ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
              </p>
            </div>

            <div class="reviews" id="reviews"></div>

            <div class="form" aria-label="Review form">
              <div class="formgrid">
                <div>
                  <div class="muted" style="font-size:12px; margin:0 0 6px;">Name / ãŠåå‰ï¼ˆåˆå›ã®ã¿ï¼‰</div>
                  <input id="rv_name" placeholder="e.g. Alex / ã‚¢ãƒ¬ãƒƒã‚¯ã‚¹" maxlength="30" />
                </div>
                <div>
                  <div class="muted" style="font-size:12px; margin:0 0 6px;">Rating / è©•ä¾¡</div>
                  <select id="rv_rating">
                    <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
                    <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
                    <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
                    <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
                    <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
                  </select>
                </div>
              </div>
              <div style="margin-top:10px;">
                <div class="muted" style="font-size:12px; margin:0 0 6px;">Comment / ã‚³ãƒ¡ãƒ³ãƒˆ</div>
                <textarea id="rv_msg" placeholder="Short impressions / ã²ã¨ã“ã¨æ„Ÿæƒ³ï¼ˆçŸ­ã‚æ¨å¥¨ï¼‰" maxlength="240"></textarea>
              </div>
              <div class="actions" style="margin-top:10px;">
                <button id="submitReviewBtn" type="button">æŠ•ç¨¿ã™ã‚‹ / Post</button>
                <button class="secondary" id="exportReviewsBtn" type="button">â¬‡ï¸ Export JSON</button>
              </div>
              <div class="hint muted">
                â€» æŠ•ç¨¿å¾Œã€ã“ã®éŠ˜æŸ„ã¯ã€ŒMy Pageï¼ˆå±¥æ­´ï¼‰ã€ã«è‡ªå‹•ã§è¿½åŠ ã•ã‚Œã¾ã™ã€‚
              </div>
            </div>

          </div>
        </div>
      </aside>

      <!-- My Page (when no ?id) -->
      <section class="card" id="listCard" style="display:none; grid-column: 1 / -1;">
        <div class="hd">
          <div class="title">
            <div class="jp">My Page / å±¥æ­´</div>
            <div class="en">Your reviewed bottles on this device.</div>
          </div>
          <div class="tags">
            <span class="tag" id="countTag">â€”</span>
            <span class="tag" id="meTag">me: â€”</span>
          </div>
        </div>
        <div class="body">
          <div class="reviewHead" style="margin-bottom:12px;">
            <div class="h1" style="margin-bottom:6px;">
              <span>â­ å±¥æ­´ã®è¦‹æ–¹ / How it works</span>
              <span class="badge muted" id="myNameBadge">name: â€”</span>
            </div>
            <p class="desc">
              ã“ã“ã«ã¯ã€Œã“ã®ç«¯æœ«ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã—ãŸéŠ˜æŸ„ã€ãŒè‡ªå‹•ã§æºœã¾ã‚Šã¾ã™ã€‚<br/>
              QRã§å€‹åˆ¥ãƒšãƒ¼ã‚¸ã«è¡Œãã€ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æŠ•ç¨¿ã™ã‚‹ã¨å±¥æ­´ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼ˆç«¯æœ«ã”ã¨ã«ä¿å­˜ï¼‰ã€‚
            </p>
            <div class="actions" style="margin-top:10px;">
              <button class="secondary" id="changeNameBtn" type="button">åå‰ã‚’å¤‰æ›´ / Change name</button>
            </div>
            <div class="hint muted">â€» åå‰ã‚’å¤‰ãˆã‚‹ã¨æ¬¡å›ä»¥é™ã®æŠ•ç¨¿åãŒå¤‰ã‚ã‚Šã¾ã™ï¼ˆéå»ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è¡¨ç¤ºåã¯å¤‰ã‚ã‚Šã¾ã›ã‚“ï¼‰ã€‚</div>
          </div>

          <div class="badge">âœï¸ My Reviews / ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ãŸéŠ˜æŸ„</div>
          <div class="list" id="myReviewedList" style="margin-top:10px;"></div>

          <div class="hr"></div>

          <div class="badge muted">ğŸ” All bottles / å…¨éŠ˜æŸ„ï¼ˆã‚¹ã‚¿ãƒƒãƒ•ç”¨ï¼‰</div>
          <div class="list" id="list" style="margin-top:10px;"></div>

          <div class="hint muted">â€» å€‹åˆ¥ãƒšãƒ¼ã‚¸ã¯ <span class="muted">?id=xxxx</span> ã§é–‹ãã¾ã™ã€‚</div>
        </div>
      </section>
    </main>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

  <script>
    // =========================
    // Firebaseè¨­å®šï¼ˆè¦å·®ã—æ›¿ãˆï¼‰
    // =========================
    const firebaseConfig = {
      apiKey: "AIzaSyD1sbz6sLUMf6tabsjwvteEOoQB6vFlcZU",
      authDomain: "the-sake-council-reviews.firebaseapp.com",
      projectId: "the-sake-council-reviews",
    };

    // =========================
    // App settings
    // =========================
    const CSV_PATH = "./sake.csv";
    const JAPAN_SVG_PATH = "./assets/japan_pref.svg";
    const REVIEWS_COLLECTION = "reviews";
    const USERS_COLLECTION   = "users";
    const REVIEW_LIMIT = 60;

    const statusEl = document.getElementById("status");

    const qs = new URLSearchParams(location.search);
    const targetId = qs.get("id");
    let currentSakeId = null;

    // Firebase init
    let db = null;
    let auth = null;
    let me = null;

    try{
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      auth = firebase.auth();
    }catch(e){
      console.error(e);
    }

    // ---------- Helpers ----------
    function clamp01(n){ return Math.max(0, Math.min(1, n)); }
    function toNum(v, fallback=0){
      const n = Number(String(v).replace(/[^\d.-]/g,""));
      return Number.isFinite(n) ? n : fallback;
    }
    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }
    function stars(n){
      const k = Math.max(1, Math.min(5, Number(n)||0));
      return "â˜…â˜…â˜…â˜…â˜…".slice(0,k) + "â˜†â˜†â˜†â˜†â˜†".slice(0,5-k);
    }
    function jpOrEn(jp, en){
      const a = String(jp||"").trim();
      const b = String(en||"").trim();
      if (a && b) return `${a} / ${b}`;
      return a || b || "â€”";
    }
    function pick(...xs){
      for (const x of xs){
        const s = String(x ?? "").trim();
        if (s) return s;
      }
      return "";
    }

    // ---------- Auth (Anonymous) + displayName ----------
    const LS_NAME_KEY = "tsc_displayName";

    async function ensureAnonAuth(){
      if(!auth) throw new Error("Auth not ready");
      if(auth.currentUser) return auth.currentUser;
      const cred = await auth.signInAnonymously();
      return cred.user;
    }

    function setMeTag(){
      const el = document.getElementById("meTag");
      if (!el) return;
      if (!me) { el.textContent = "me: â€”"; return; }
      el.textContent = `me: ${me.isAnonymous ? "guest" : "user"} Â· ${String(me.uid).slice(0,6)}`;
    }

    async function loadMyProfile(){
      if (!db || !me) return { displayName: localStorage.getItem(LS_NAME_KEY) || "" };

      try{
        const ref = db.collection(USERS_COLLECTION).doc(me.uid);
        const snap = await ref.get();
        const dn = snap.exists ? (snap.data()?.displayName || "") : "";
        const local = localStorage.getItem(LS_NAME_KEY) || "";
        const displayName = dn || local || "";
        if (displayName) localStorage.setItem(LS_NAME_KEY, displayName);
        return { displayName };
      }catch(e){
        console.error(e);
        return { displayName: localStorage.getItem(LS_NAME_KEY) || "" };
      }
    }

    async function saveMyDisplayName(name){
      const displayName = String(name||"").trim().slice(0,30);
      if (!displayName) throw new Error("Empty displayName");

      localStorage.setItem(LS_NAME_KEY, displayName);

      if (db && me){
        await db.collection(USERS_COLLECTION).doc(me.uid).set({
          displayName,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge:true });
      }
      return displayName;
    }

    function setMyNameBadge(name){
      const b = document.getElementById("myNameBadge");
      if (!b) return;
      b.textContent = `name: ${name ? escapeHtml(name) : "â€”"}`;
    }

    // ---------- CSV parsing ----------
    function parseCSV(text){
      const rows = [];
      let cur = "", inQ = false;
      const out = [];
      for (let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if (ch === '"' && inQ && next === '"'){ cur += '"'; i++; continue; }
        if (ch === '"'){ inQ = !inQ; continue; }
        if (!inQ && ch === ","){ out.push(cur); cur=""; continue; }
        if (!inQ && ch === "\n"){ out.push(cur); rows.push(out.slice()); out.length=0; cur=""; continue; }
        if (ch === "\r") continue;
        cur += ch;
      }
      out.push(cur);
      if (out.some(v => (v ?? "").trim() !== "")) rows.push(out.slice());

      const header = rows.shift().map(h => h.trim());
      return rows
        .filter(r => r.some(v => (v ?? "").trim() !== ""))
        .map(r => {
          const obj = {};
          header.forEach((h, idx) => obj[h] = (r[idx] ?? "").trim());
          return obj;
        });
    }

    // ---------- Taste visuals ----------
    function setBar(elId, value0to5){
      const v = Math.max(0, Math.min(5, toNum(value0to5, 0)));
      const pct = (v/5)*100;
      const el = document.getElementById(elId);
      if (el) el.style.width = pct + "%";
      return v;
    }

    function tasteSvg({sweet, aroma, body, acid}){
      const W=220, H=160, cx=W/2, cy=H/2;
      const max=5, r=58;

      const a = clamp01(aroma/max)*r;
      const s = clamp01(sweet/max)*r;
      const b = clamp01(body/max)*r;
      const ac = clamp01(acid/max)*r;

      const pTop    = [cx, cy - a];
      const pRight  = [cx + s, cy];
      const pBottom = [cx, cy + b];
      const pLeft   = [cx - ac, cy];

      const grid = [1,2,3,4,5].map(i=>{
        const rr = (i/max)*r;
        return `<polygon points="${cx},${cy-rr} ${cx+rr},${cy} ${cx},${cy+rr} ${cx-rr},${cy}"
                  fill="none" stroke="rgba(255,255,255,.10)" stroke-width="1"/>`;
      }).join("");

      return `
        <svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" role="img" aria-label="Taste chart">
          ${grid}
          <line x1="${cx}" y1="${cy-r}" x2="${cx}" y2="${cy+r}" stroke="rgba(255,255,255,.12)"/>
          <line x1="${cx-r}" y1="${cy}" x2="${cx+r}" y2="${cy}" stroke="rgba(255,255,255,.12)"/>
          <polygon points="${pTop.join(",")} ${pRight.join(",")} ${pBottom.join(",")} ${pLeft.join(",")}"
                   fill="rgba(215,181,109,.25)" stroke="rgba(215,181,109,.75)" stroke-width="2"/>
          <text x="${cx}" y="${cy-r-8}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Aroma</text>
          <text x="${cx+r+8}" y="${cy+4}" text-anchor="start" font-size="11" fill="rgba(255,255,255,.70)">Sweet/Dry</text>
          <text x="${cx}" y="${cy+r+18}" text-anchor="middle" font-size="11" fill="rgba(255,255,255,.70)">Body</text>
          <text x="${cx-r-8}" y="${cy+4}" text-anchor="end" font-size="11" fill="rgba(255,255,255,.70)">Acidity</text>
        </svg>
      `;
    }

    // ---------- Japan SVG Map (Geolonia prefecture svg å¯¾å¿œ) ----------
    function prefectureFromRegionJP(regionJP){
      const s = String(regionJP||"").trim();
      const m = s.match(/(åŒ—æµ·é“|æ±äº¬éƒ½|..åºœ|..çœŒ)/);
      return m ? m[1] : "";
    }

    const PREF_JP_TO_CLASS = {
      "åŒ—æµ·é“":"hokkaido","é’æ£®çœŒ":"aomori","å²©æ‰‹çœŒ":"iwate","å®®åŸçœŒ":"miyagi","ç§‹ç”°çœŒ":"akita","å±±å½¢çœŒ":"yamagata","ç¦å³¶çœŒ":"fukushima",
      "èŒ¨åŸçœŒ":"ibaraki","æ ƒæœ¨çœŒ":"tochigi","ç¾¤é¦¬çœŒ":"gunma","åŸ¼ç‰çœŒ":"saitama","åƒè‘‰çœŒ":"chiba","æ±äº¬éƒ½":"tokyo","ç¥å¥ˆå·çœŒ":"kanagawa",
      "æ–°æ½ŸçœŒ":"niigata","å¯Œå±±çœŒ":"toyama","çŸ³å·çœŒ":"ishikawa","ç¦äº•çœŒ":"fukui","å±±æ¢¨çœŒ":"yamanashi","é•·é‡çœŒ":"nagano",
      "å²é˜œçœŒ":"gifu","é™å²¡çœŒ":"shizuoka","æ„›çŸ¥çœŒ":"aichi","ä¸‰é‡çœŒ":"mie","æ»‹è³€çœŒ":"shiga","äº¬éƒ½åºœ":"kyoto","å¤§é˜ªåºœ":"osaka",
      "å…µåº«çœŒ":"hyogo","å¥ˆè‰¯çœŒ":"nara","å’Œæ­Œå±±çœŒ":"wakayama",
      "é³¥å–çœŒ":"tottori","å³¶æ ¹çœŒ":"shimane","å²¡å±±çœŒ":"okayama","åºƒå³¶çœŒ":"hiroshima","å±±å£çœŒ":"yamaguchi",
      "å¾³å³¶çœŒ":"tokushima","é¦™å·çœŒ":"kagawa","æ„›åª›çœŒ":"ehime","é«˜çŸ¥çœŒ":"kochi",
      "ç¦å²¡çœŒ":"fukuoka","ä½è³€çœŒ":"saga","é•·å´çœŒ":"nagasaki","ç†Šæœ¬çœŒ":"kumamoto","å¤§åˆ†çœŒ":"oita","å®®å´çœŒ":"miyazaki",
      "é¹¿å…å³¶çœŒ":"kagoshima","æ²–ç¸„çœŒ":"okinawa",
    };

    let japanSvgEl = null;

    function getPrefGroups(svg){
      return Array.from(svg.querySelectorAll("g.prefecture"));
    }

    function markPrefShapes(svg){
      const groups = getPrefGroups(svg);
      groups.forEach(g=>{
        const title = g.querySelector("title")?.textContent || "";
        const jpName = title.split("/")[0].trim();
        if (jpName) g.dataset.jp = jpName;

        g.querySelectorAll("path, polygon").forEach(shape=>{
          shape.classList.add("pref");
        });
      });
    }

    async function loadJapanMapSvg(){
      const res = await fetch(JAPAN_SVG_PATH, { cache: "no-store" });
      if(!res.ok) throw new Error("SVG fetch failed: " + res.status);
      const svgText = await res.text();

      const wrap = document.getElementById("mapWrap");
      wrap.innerHTML = svgText;

      const svg = wrap.querySelector("svg");
      if(!svg) throw new Error("SVG not found inside mapWrap");

      markPrefShapes(svg);

      japanSvgEl = svg;
      return svg;
    }

    function findPrefGroup(svg, prefJpWithSuffix){
      if(!svg || !prefJpWithSuffix) return null;

      const prefShort = prefJpWithSuffix
        .replace("éƒ½","")
        .replace("é“","")
        .replace("åºœ","")
        .replace("çœŒ","");

      const cls = PREF_JP_TO_CLASS[prefJpWithSuffix];
      if (cls){
        const byClass = svg.querySelector(`g.prefecture.${CSS.escape(cls)}`);
        if (byClass) return byClass;
      }

      const groups = getPrefGroups(svg);
      for(const g of groups){
        const jp = (g.dataset.jp || "").trim();
        if (jp === prefShort) return g;
        const title = g.querySelector("title")?.textContent || "";
        if (title.includes(prefShort)) return g;
      }
      return null;
    }

    function highlightPrefOnMap(prefJp){
      const meta = document.getElementById("mapMeta");
      if(meta) meta.textContent = prefJp || "â€”";

      if(!japanSvgEl) return;
      const svg = japanSvgEl;

      svg.querySelectorAll(".pref").forEach(el=>{
        el.classList.remove("active");
        el.classList.remove("dim");
      });

      if(!prefJp) return;

      const group = findPrefGroup(svg, prefJp);
      if(!group){
        console.warn("Map: prefecture not matched:", prefJp);
        return;
      }

      svg.querySelectorAll(".pref").forEach(el=> el.classList.add("dim"));

      group.querySelectorAll("path.pref, polygon.pref").forEach(shape=>{
        shape.classList.remove("dim");
        shape.classList.add("active");
      });
    }

    // ---------- My reviewed list ----------
    async function loadMyReviewed(){
      if (!db || !me) return [];
      const snap = await db
        .collection(USERS_COLLECTION)
        .doc(me.uid)
        .collection("reviewed")
        .orderBy("reviewedAt", "desc")
        .limit(200)
        .get();

      const out = [];
      snap.forEach(d => out.push({ id: d.id, ...d.data() }));
      return out;
    }

    function renderMyReviewedSection(reviewed){
      const listEl = document.getElementById("myReviewedList");
      if (!listEl) return;
      listEl.innerHTML = "";

      if (!reviewed || reviewed.length === 0){
        listEl.innerHTML = `
          <div class="item" style="grid-column:1/-1;">
            <div class="n">ã¾ã å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>
            <div class="s">QRã§éŠ˜æŸ„ãƒšãƒ¼ã‚¸ â†’ ãƒ¬ãƒ“ãƒ¥ãƒ¼æŠ•ç¨¿ã™ã‚‹ã¨ã€ã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ã€‚</div>
          </div>
        `;
        return;
      }

      reviewed.forEach(s=>{
        const url = `${location.pathname}?id=${encodeURIComponent(s.sakeId || s.id)}`;
        const jp = escapeHtml(s.name_jp || s.sakeId || s.id || "â€”");
        const en = escapeHtml(s.name_en || "");
        const region = escapeHtml(s.region_jp || "");
        const style = escapeHtml(s.style_en || "");
        const card = document.createElement("div");
        card.className = "item";
        card.innerHTML = `
          <div class="n">âœï¸ ${jp}</div>
          <div class="s">${en}</div>
          <div class="badge">${style} Â· <span class="muted">${region}</span></div>
          <div class="go">
            <a class="btn secondary" href="${url}">Open / é–‹ã</a>
          </div>
        `;
        listEl.appendChild(card);
      });
    }

    // ---------- Shared reviews ----------
    function reviewDocToUi(doc){
      const r = doc.data();
      const d = r.ts?.toDate?.() ?? new Date();
      return {
        id: doc.id,
        name: (r.name || "Guest"),
        rating: Math.max(1, Math.min(5, Number(r.rating)||5)),
        msg: (r.msg || ""),
        dateText: d.toLocaleString()
      };
    }

    function setRatingBadge(avg, count){
      const b = document.getElementById("ratingBadge");
      if (!b) return;
      if (!count){ b.textContent = "â€”"; return; }
      b.textContent = `â˜… ${avg.toFixed(1)} / 5  (${count})`;
    }

    function renderReviewsShared(list){
      const box = document.getElementById("reviews");
      box.innerHTML = "";

      if (!list || list.length === 0){
        box.innerHTML = `<div class="hint muted">No reviews yet. / ã¾ã ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</div>`;
        setRatingBadge(0, 0);
        return;
      }

      const sum = list.reduce((a,b)=>a+(b.rating||0),0);
      const avg = sum / list.length;
      setRatingBadge(avg, list.length);

      list.forEach(r => {
        const el = document.createElement("div");
        el.className = "review";
        el.innerHTML = `
          <div class="top">
            <span>${escapeHtml(r.name)} Â· ${escapeHtml(stars(r.rating))}</span>
            <span>${escapeHtml(r.dateText)}</span>
          </div>
          <div class="msg">${escapeHtml(r.msg)}</div>
        `;
        box.appendChild(el);
      });
    }

    let unsubscribeReviews = null;
    let lastReviewsCache = [];

    async function listenReviewsShared(sakeId){
      if (!db){
        statusEl.textContent = "Firebase init error / Firebaseè¨­å®šã‚’ç¢ºèª";
        renderReviewsShared([]);
        return;
      }
      if (typeof unsubscribeReviews === "function") unsubscribeReviews();

      unsubscribeReviews = db.collection(REVIEWS_COLLECTION)
        .where("sakeId", "==", sakeId)
        .orderBy("ts", "desc")
        .limit(REVIEW_LIMIT)
        .onSnapshot(snapshot => {
          const list = [];
          snapshot.forEach(doc => list.push(reviewDocToUi(doc)));
          lastReviewsCache = list;
          renderReviewsShared(list);
        }, err => {
          console.error(err);
          const code = err?.code ? ` (${err.code})` : "";
          const msg  = err?.message ? err.message : String(err);
          statusEl.textContent = `Review load error${code}: ${msg}`;
        });
    }

    function myReviewDocId(sakeId, uid){
  return `${String(sakeId).slice(0,60)}_${String(uid).slice(0,80)}`;
}

    async function postReviewShared(sakeId, {name, rating, msg}){
    me = me || await ensureAnonAuth();
    if (!db) throw new Error("Firestore not ready");

    const clean = {
        sakeId: String(sakeId || "").slice(0, 60),
        name: String(name || "Guest").trim().slice(0, 30),
        rating: Math.max(1, Math.min(5, Number(rating)||5)),
        msg: String(msg || "").trim().slice(0, 240),
        ts: firebase.firestore.FieldValue.serverTimestamp(),
        uid: String(me?.uid || "anon").slice(0, 80),
    };
    if (!clean.msg) throw new Error("Empty message");

    const docId = myReviewDocId(clean.sakeId, me.uid);

    // docIdå›ºå®šã§ã€Œ1å›ã ã‘æŠ•ç¨¿ã€ã«ãªã‚‹
    // æ—¢ã«å­˜åœ¨ã™ã‚‹ã¨ Rules ã§ create ãŒæ‹’å¦ã•ã‚Œã‚‹ï¼ˆï¼äºŒé‡æŠ•ç¨¿é˜²æ­¢ï¼‰
    await db.collection(REVIEWS_COLLECTION).doc(docId).set(clean);
    }

    async function markReviewed(sakeId, bottleMeta){
      if (!db || !me) return;
      const ref = db.collection(USERS_COLLECTION).doc(me.uid)
        .collection("reviewed").doc(String(sakeId));
      await ref.set({
        sakeId: String(sakeId),
        name_jp: bottleMeta?.name_jp || "",
        name_en: bottleMeta?.name_en || "",
        region_jp: bottleMeta?.region_jp || "",
        style_en: bottleMeta?.style_en || "",
        reviewedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });
    }

    function exportReviewsJSON(){
      const data = lastReviewsCache.map(r => ({
        name: r.name, rating: r.rating, msg: r.msg, date: r.dateText
      }));
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `reviews_${currentSakeId || "unknown"}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ---------- Story (auto) ----------
    function buildStory(it){
      const region = pick(it.region_en, it.region_jp);
      const brewery = pick(it.brewery_en, it.brewery_jp);
      const style = pick(it.style_en, it.style_jp);
      const rice = pick(it.rice_en, it.rice_jp);
      const aroma = pick(it.aroma_en, it.aroma_jp);
      const palate = pick(it.palate_en, it.palate_jp);

      const en = `${region} Â· ${brewery}. A ${style} sake${rice ? ` using ${rice}` : ""}. ${aroma ? `Aroma: ${aroma}.` : ""} ${palate ? `Palate: ${palate}.` : ""}`.replace(/\s+/g," ").trim();
      const jp = `${pick(it.region_jp,it.region_en)}ã®${pick(it.brewery_jp,it.brewery_en)}ã€‚${pick(it.style_jp,it.style_en)}${it.rice_jp ? `ï¼ˆ${it.rice_jp}ï¼‰` : ""}ã®é­…åŠ›ã€‚${it.aroma_jp ? `é¦™ã‚Šï¼š${it.aroma_jp}ã€‚` : ""}${it.palate_jp ? `å‘³ã‚ã„ï¼š${it.palate_jp}ã€‚` : ""}`.replace(/\s+/g," ").trim();
      return jpOrEn(jp, en);
    }

    // ---------- render all bottles (staff) ----------
    function renderAllBottles(items){
      const list = document.getElementById("list");
      if (!list) return;
      list.innerHTML = "";

      items.forEach(it=>{
        const card = document.createElement("div");
        card.className = "item";
        const url = `${location.pathname}?id=${encodeURIComponent(it.id)}`;
        const type = pick(it["åˆ†é¡ã‚¿ã‚¤ãƒ—"], it.style_en, it.style_jp, "â€”");
        const region = pick(it.region_en, it.region_jp, "â€”");
        card.innerHTML = `
          <div class="n">${escapeHtml(it.name_jp || it.id || "â€”")}</div>
          <div class="s">${escapeHtml(it.name_en || "")}</div>
          <div class="badge">${escapeHtml(type)} Â· <span class="muted">${escapeHtml(region)}</span></div>
          <div class="go">
            <a class="btn secondary" href="${url}">Open / é–‹ã</a>
          </div>
        `;
        list.appendChild(card);
      });
    }

    async function renderSheet(it){
      window.__currentBottleMeta = it;

      currentSakeId = it.id;
      document.getElementById("sheetCard").style.display = "";
      document.getElementById("sideCard").style.display = "";

      document.getElementById("name_jp").textContent = it.name_jp || it.id || "â€”";
      document.getElementById("name_en").textContent = it.name_en || "";
      document.getElementById("idTag").textContent = `id: ${it.id || "â€”"}`;

      const tags = document.getElementById("tags");
      tags.innerHTML = "";
      [
        pick(it["åˆ†é¡ã‚¿ã‚¤ãƒ—"], it.style_en, it.style_jp),
        pick(it.category_en, it.category_jp),
        pick(it.region_en, it.region_jp),
        pick(it.brewery_en, it.brewery_jp),
      ].filter(Boolean).slice(0,4).forEach(t=>{
        const s = document.createElement("span");
        s.className = "tag";
        s.textContent = t;
        tags.appendChild(s);
      });

      document.getElementById("brewery").textContent = jpOrEn(it.brewery_jp, it.brewery_en);
      document.getElementById("region").textContent  = jpOrEn(it.region_jp, it.region_en);

      document.getElementById("style").textContent   = jpOrEn(it.style_jp, it.style_en);
      document.getElementById("rice").textContent    = jpOrEn(it.rice_jp, it.rice_en);

      const abv = it.abv ? `${it.abv}%` : "";
      const smv = it.smv ? `SMV ${it.smv}` : "";
      const acidityValue = it.acidity_value ? `Acidity ${it.acidity_value}` : "";
      document.getElementById("spec").textContent = [abv, smv, acidityValue].filter(Boolean).join(" Â· ") || "â€”";
      document.getElementById("polish").textContent = it.rice_polish ? `Rice polish ${it.rice_polish}%` : "â€”";

      document.getElementById("aroma").textContent   = jpOrEn(it.aroma_jp, it.aroma_en);
      document.getElementById("palate").textContent  = jpOrEn(it.palate_jp, it.palate_en);
      document.getElementById("pairing").textContent = jpOrEn(it.pairing_jp, it.pairing_en);
      document.getElementById("temp").textContent    = jpOrEn(it.temp_jp, it.temp_en);
      document.getElementById("glass").textContent   = jpOrEn(it.glass_jp, it.glass_en);
      document.getElementById("copy").textContent    = jpOrEn(it.copy_jp, it.copy_en);

      document.getElementById("storyText").textContent = buildStory(it);
      document.getElementById("storyHint").textContent = "auto";

      const sweet = setBar("bar_sweet", it.sweet);
      const aroma = setBar("bar_aroma", it.aroma_intensity);
      const body  = setBar("bar_body",  it.body);
      const acid  = setBar("bar_acid",  it.acidity);

      document.getElementById("val_sweet").textContent = sweet.toFixed(0);
      document.getElementById("val_aroma").textContent = aroma.toFixed(0);
      document.getElementById("val_body").textContent  = body.toFixed(0);
      document.getElementById("val_acid").textContent  = acid.toFixed(0);

      document.getElementById("tasteSvgWrap").innerHTML = tasteSvg({sweet, aroma, body, acid});

      const pref = prefectureFromRegionJP(it.region_jp || "");
      highlightPrefOnMap(pref);

      // My Page link from bottle page
      const myPageBtn = document.getElementById("myPageBtn");
      if (myPageBtn){
        myPageBtn.onclick = async (e) => {
          e.preventDefault();
          try{
            me = me || await ensureAnonAuth();
            setMeTag();
          }catch(_){}
          location.href = "./index.html";
        };
      }

      // Start reviews listener
      listenReviewsShared(it.id);

      // Post button
      document.getElementById("submitReviewBtn").onclick = async () => {
        try{
          me = me || await ensureAnonAuth();
          setMeTag();

          // 1) input
          let name = (document.getElementById("rv_name").value || "").trim();
          const rating = Number(document.getElementById("rv_rating").value || 5);
          const msg = document.getElementById("rv_msg").value || "";

          // 2) if empty, try saved name; else ask to input
          if (!name){
            const prof = await loadMyProfile();
            if (prof.displayName){
              name = prof.displayName;
              document.getElementById("rv_name").value = name;
            }else{
              statusEl.textContent = "Please enter your name first / ãŠåå‰ã‚’å…¥ã‚Œã¦ãã ã•ã„";
              document.getElementById("rv_name").focus();
              return;
            }
          }

          // 3) save name (registration)
          await saveMyDisplayName(name);

          // 4) post
          await postReviewShared(currentSakeId, { name, rating, msg });

          // 5) mark reviewed (my history)
          await markReviewed(currentSakeId, window.__currentBottleMeta || null);

          document.getElementById("rv_msg").value = "";
          statusEl.textContent = "Posted âœ… / æŠ•ç¨¿ã—ã¾ã—ãŸ";
        }catch(err){
        console.error(err);
        const code = err?.code || "";
        const m  = err?.message ? err.message : String(err);

        // äºŒé‡æŠ•ç¨¿æ™‚ã¯ permission-denied ã«ãªã‚Šã‚„ã™ã„ã®ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‹å¥½çš„ã«
        if (code === "permission-denied" || /permission/i.test(m)) {
            statusEl.textContent = "You already posted a review for this bottle. / ã“ã®éŠ˜æŸ„ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯1å›ã¾ã§ã§ã™ï¼ˆä¿®æ­£ã¯ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå£°ãŒã‘ãã ã•ã„ï¼‰";
        } else {
            statusEl.textContent = `Post failed${code ? ` (${code})` : ""}: ${m}`;
        }
        }
        };

      document.getElementById("exportReviewsBtn").onclick = () => {
        exportReviewsJSON();
        statusEl.textContent = "Exported âœ… / æ›¸ãå‡ºã—ã¾ã—ãŸ";
      };
    }

    async function main(){
      try{
        if (auth){
          auth.onAuthStateChanged(u => {
            me = u || null;
            setMeTag();
          });
        }

        // âœ… auto anonymous login (always)
        try{
          me = await ensureAnonAuth();
          setMeTag();

          // restore saved name into form (if exists)
          const prof = await loadMyProfile();
          if (prof.displayName){
            const nameEl = document.getElementById("rv_name");
            if (nameEl) nameEl.value = prof.displayName;
            setMyNameBadge(prof.displayName);
          }else{
            setMyNameBadge("");
          }
        }catch(e){
          console.error(e);
          statusEl.textContent = "Auth error / èªè¨¼ã‚¨ãƒ©ãƒ¼ï¼ˆAnonymousæœ‰åŠ¹åŒ–ã‚’ç¢ºèªï¼‰";
        }

        // load map svg early
        try{
          await loadJapanMapSvg();
        }catch(e){
          console.error(e);
          statusEl.textContent = "Map load error / japan_pref.svg ã‚’ç¢ºèª";
        }

        // load CSV
        const res = await fetch(CSV_PATH, { cache: "no-store" });
        if(!res.ok) throw new Error("CSV fetch failed: " + res.status);
        const text = await res.text();
        const items = parseCSV(text);

        statusEl.textContent = `CSV loaded âœ… (${items.length})`;

        // My Page (no ?id)
        if(!targetId){
          document.getElementById("listCard").style.display = "";

          // My name badge
          try{
            const prof = await loadMyProfile();
            setMyNameBadge(prof.displayName || "");
          }catch(_){}

          // Change name (only affects future posts)
          const changeBtn = document.getElementById("changeNameBtn");
          if (changeBtn){
            changeBtn.onclick = async () => {
              const current = localStorage.getItem(LS_NAME_KEY) || "";
              const next = prompt("è¡¨ç¤ºåï¼ˆæ¬¡å›ä»¥é™ã®æŠ•ç¨¿åï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ30æ–‡å­—ä»¥å†…ï¼‰", current);
              if (next === null) return;
              const nm = String(next || "").trim().slice(0,30);
              if (!nm){
                alert("ç©ºã¯ä¸å¯ã§ã™ã€‚");
                return;
              }
              try{
                me = me || await ensureAnonAuth();
                await saveMyDisplayName(nm);
                setMyNameBadge(nm);
                statusEl.textContent = "Name updated âœ… / åå‰ã‚’æ›´æ–°ã—ã¾ã—ãŸ";
              }catch(e){
                console.error(e);
                statusEl.textContent = "Name update failed / æ›´æ–°å¤±æ•—";
              }
            };
          }

          // Load my reviewed history
          try{
            me = me || await ensureAnonAuth();
            const reviewed = await loadMyReviewed();
            renderMyReviewedSection(reviewed);
          }catch(e){
            console.warn("reviewed load skipped", e);
            renderMyReviewedSection([]);
          }

          // Staff list
          document.getElementById("countTag").textContent = `${items.length} bottles`;
          renderAllBottles(items);
          return;
        }

        // Bottle page (?id)
        const it = items.find(x => String(x.id) === String(targetId));
        if(!it){
          statusEl.textContent = "Not found / éŠ˜æŸ„IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
          document.getElementById("listCard").style.display = "";
          document.getElementById("countTag").textContent = `${items.length} bottles`;
          renderAllBottles(items);
          return;
        }

        await renderSheet(it);

      }catch(err){
        console.error(err);
        statusEl.textContent = "Load error / èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
        document.getElementById("listCard").style.display = "";
        document.getElementById("list").innerHTML =
          `<div class="item" style="grid-column:1/-1;">
             <div class="n">Could not load data</div>
             <div class="s">Put <span class="muted">${escapeHtml(CSV_PATH)}</span> next to index.html / åŒéšå±¤ã«sake.csvã‚’ç½®ã„ã¦ãã ã•ã„ã€‚</div>
             <div class="s muted">â€» file:// ç›´é–‹ãã ã¨ fetch ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚Webå…¬é–‹ï¼ˆGitHub Pagesç­‰ï¼‰æ¨å¥¨ã€‚</div>
           </div>`;
      }
    }

    main();
  </script>
</body>
</html>
